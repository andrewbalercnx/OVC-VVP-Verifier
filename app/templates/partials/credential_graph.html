{# Credential chain graph partial #}

{% if error %}
<article aria-invalid="true">
    <header>Graph Error</header>
    <p>{{ error }}</p>
</article>
{% else %}

<h3>Credential Chain Graph</h3>

{# Trust path indicator #}
{% if graph.trustPathValid %}
<article style="background:var(--vvp-success);color:white;padding:0.5rem 1rem;">
    Valid trust path to root
</article>
{% else %}
<article aria-invalid="true" style="padding:0.5rem 1rem;">
    No valid trust path to root (issuer not in trusted roots list)
</article>
{% endif %}

{# Render layers with SVG connectors #}
{% if graph.layers and graph.layers | length > 0 %}
<div id="graph-container" class="credential-graph-container" data-edges="{{ graph.edges | tojson | e }}">
    {# SVG overlay for connector lines #}
    <svg id="graph-connectors" class="graph-connectors"></svg>

    {% for layer_ids in graph.layers %}
    {% set layer_idx = loop.index0 %}
    <div class="graph-layer" data-layer="{{ layer_idx }}">
        {# Layer label #}
        {% if layer_idx == 0 %}
            {% set has_root = false %}
            {% for node_id in layer_ids %}
                {% set node = graph.nodes | selectattr('id', 'equalto', node_id) | first %}
                {% if node and node.isRoot %}
                    {% set has_root = true %}
                {% endif %}
            {% endfor %}
            <h5 class="layer-label">
                {% if has_root %}Root of Trust{% else %}Chain Terminus (Untrusted Issuer){% endif %}
            </h5>
        {% else %}
            <h5 class="layer-label">
                Layer {{ layer_idx }} - Issued Credentials
            </h5>
        {% endif %}

        {# Render credentials in this layer #}
        <div class="layer-cards">
            {% for node_id in layer_ids %}
            {% set node = graph.nodes | selectattr('id', 'equalto', node_id) | first %}
            {% if node %}
            {% set acdc = {
                'd': node.id,
                'i': node.issuer,
                's': node.schemaSaid,
                'type': node.type,
                'displayName': node.displayName,
                'status': node.status or 'UNKNOWN',
                'a': node.attributes or {},
                'e': node.edges or {}
            } %}
            {% include "partials/credential_card.html" %}
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>
{% elif graph.nodes and graph.nodes | length > 0 %}
<article>
    <p>No layers computed, but {{ graph.nodes | length }} node(s) exist.</p>
    <div style="display:flex;flex-wrap:wrap;gap:0.75rem;">
        {% for node in graph.nodes %}
        {% set acdc = {
            'd': node.id,
            'i': node.issuer,
            's': node.schemaSaid,
            'type': node.type,
            'displayName': node.displayName,
            'status': node.status or 'UNKNOWN',
            'a': node.attributes or {},
            'e': node.edges or {}
        } %}
        {% include "partials/credential_card.html" %}
        {% endfor %}
    </div>
</article>
{% else %}
<article aria-invalid="true">
    <p>No credentials found in graph.</p>
</article>
{% endif %}

{% endif %}
