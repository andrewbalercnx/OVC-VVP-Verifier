{# Enhanced credential card partial #}
{#
   Accepts either:
   - vm: CredentialCardViewModel (new view-model, preferred)
   - acdc: Raw ACDC dict (legacy, for backwards compatibility)

   When using view-model (vm), provides:
   - Normalized primary/secondary attributes
   - Lazy revocation badge loading
   - Chain expansion with availability checks
   - Variant limitation banners
#}

{% if vm %}
{# ===== NEW VIEW-MODEL PATH ===== #}

{% set status_class = 'valid' if vm.status == 'VALID' else ('invalid' if vm.status == 'INVALID' else 'indeterminate') %}

<article class="credential-card {{ status_class }}" data-said="{{ vm.said }}">
  <header style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem;">
    <span>
      {# Credential type badge #}
      <span class="badge badge-{{ vm.credential_type | lower }}">{{ vm.credential_type }}</span>

      {# Primary attribute or truncated SAID #}
      <strong class="credential-primary">{{ vm.primary.value }}</strong>
    </span>

    <span>
      {# Status badge #}
      {% if vm.status == 'VALID' %}
      <span class="badge badge-success">{{ vm.status }}</span>
      {% elif vm.status == 'INVALID' %}
      <span class="badge badge-danger">{{ vm.status }}</span>
      {% else %}
      <span class="badge badge-warning">{{ vm.status }}</span>
      {% endif %}

      {# Trusted root indicator #}
      {% if vm.issuer.is_trusted_root %}
      <span class="badge badge-root" title="Trusted Root AID">ROOT</span>
      {% endif %}
    </span>
  </header>

  {# Variant limitation banner #}
  {% if vm.limitations.has_variant_limitations %}
  <div class="credential-limitation-banner">
    {% if vm.limitations.is_compact %}
      <small>Compact encoding - attributes not expanded</small>
    {% elif vm.limitations.is_partial %}
      <small>Partial data - some fields redacted</small>
    {% endif %}
  </div>
  {% endif %}

  <dl>
    <dt>SAID</dt>
    <dd><code style="font-size:0.8em;word-break:break-all;">{{ vm.said }}</code></dd>

    <dt>Issuer</dt>
    <dd><code style="font-size:0.8em;word-break:break-all;">{{ vm.issuer.aid_short }}</code></dd>

    {# Secondary attributes #}
    {% for attr in vm.secondary %}
    <dt>{{ attr.label }}</dt>
    <dd>{{ attr.value }}</dd>
    {% endfor %}
  </dl>

  <div class="card-meta" style="display:flex;justify-content:space-between;align-items:center;margin-top:0.5rem;">
    <small>Schema: <code style="font-size:0.8em;">{{ vm.schema_said[:16] }}...</code></small>

    {# Lazy revocation badge #}
    <div hx-post="/ui/revocation-badge"
         hx-vals='{"credential_said": "{{ vm.said }}"}'
         hx-trigger="load"
         hx-swap="outerHTML">
      <span class="badge badge-muted">Checking...</span>
    </div>
  </div>

  {# Chain expansion links #}
  {% if vm.edges %}
  <footer style="margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid #dee2e6;">
    {% for key, edge in vm.edges.items() %}
      {% if edge.said %}
        {% if edge.available %}
        <a href="#"
           hx-get="/ui/credential/{{ edge.said }}"
           hx-target="#chain-{{ vm.said }}"
           hx-swap="beforeend"
           style="margin-right:0.5rem;">
          {{ edge.label }} &rarr;
        </a>
        {% else %}
        <span class="edge-unavailable" title="Credential not in dossier">
          {{ edge.label }} (unavailable)
        </span>
        {% endif %}
      {% endif %}
    {% endfor %}

    {# Details toggle #}
    <details style="margin-top:0.5rem;">
      <summary>Raw Data</summary>
      <div class="code-block">{{ vm.raw.attributes | tojson(indent=2) }}</div>
    </details>
  </footer>
  {% endif %}

  {# Chain expansion container #}
  <div id="chain-{{ vm.said }}" class="credential-layer"></div>
</article>

{% else %}
{# ===== LEGACY RAW ACDC PATH (backwards compatibility) ===== #}

{% set cred_type = acdc.type or 'UNKNOWN' %}
{% set status = acdc.status or 'UNKNOWN' %}
{% set is_valid = status == 'ACTIVE' or status == 'VALID' %}
{% set is_invalid = status == 'REVOKED' or status == 'INVALID' %}

<article class="credential-card {% if is_valid %}valid{% elif is_invalid %}invalid{% else %}unknown{% endif %}">
    <header style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem;">
        <span>
            {# Credential type badge #}
            {% if cred_type == 'ROOT' %}
            <span class="badge badge-root">ROOT</span>
            {% elif cred_type == 'ISSUER' %}
            <span class="badge badge-issuer">ISSUER</span>
            {% elif cred_type == 'LE' %}
            <span class="badge badge-le">LE</span>
            {% elif cred_type == 'APE' %}
            <span class="badge badge-ape">APE</span>
            {% elif cred_type == 'DE' %}
            <span class="badge badge-de">DE</span>
            {% elif cred_type == 'TNAlloc' %}
            <span class="badge badge-tnalloc">TNAlloc</span>
            {% else %}
            <span class="badge badge-muted">{{ cred_type }}</span>
            {% endif %}

            {# Display name or SAID #}
            {% if acdc.displayName %}
            <strong>{{ acdc.displayName }}</strong>
            {% else %}
            <strong>{{ acdc.d[:16] }}...</strong>
            {% endif %}
        </span>

        {# Status badge #}
        {% if status == 'ACTIVE' or status == 'VALID' %}
        <span class="badge badge-success">{{ status }}</span>
        {% elif status == 'REVOKED' %}
        <span class="badge badge-danger">REVOKED</span>
        {% elif status == 'UNKNOWN' %}
        <span class="badge badge-warning">UNKNOWN</span>
        {% else %}
        <span class="badge badge-muted">{{ status }}</span>
        {% endif %}
    </header>

    <dl>
        <dt>SAID</dt>
        <dd><code style="font-size:0.8em;word-break:break-all;">{{ acdc.d }}</code></dd>

        {% if acdc.i %}
        <dt>Issuer AID</dt>
        <dd><code style="font-size:0.8em;word-break:break-all;">{{ acdc.i }}</code></dd>
        {% endif %}

        {% if acdc.s %}
        <dt>Schema SAID</dt>
        <dd><code style="font-size:0.8em;">{{ acdc.s[:24] }}...</code></dd>
        {% endif %}
    </dl>

    {# Attributes section #}
    {% if acdc.a and acdc.a is mapping %}
    <details>
        <summary>Attributes</summary>
        {% if acdc.a.vcard %}
        <h5>vCard</h5>
        <ul>
            {% for line in acdc.a.vcard %}
            <li><code>{{ line }}</code></li>
            {% endfor %}
        </ul>
        {% endif %}

        {% if acdc.a.legalName %}
        <p><strong>Legal Name:</strong> {{ acdc.a.legalName }}</p>
        {% endif %}

        {% if acdc.a.LEI or acdc.a.lids %}
        <p><strong>LEI:</strong> {{ acdc.a.LEI or acdc.a.lids[0] }}</p>
        {% endif %}

        {% if acdc.a.tn %}
        <p><strong>Telephone Numbers:</strong>
            {% if acdc.a.tn is string %}
                {{ acdc.a.tn }}
            {% else %}
                {{ acdc.a.tn | join(', ') }}
            {% endif %}
        </p>
        {% endif %}

        <details>
            <summary>Raw Attributes</summary>
            <div class="code-block">{{ acdc.a | tojson(indent=2) }}</div>
        </details>
    </details>
    {% endif %}

    {# Edges section #}
    {% if acdc.e and acdc.e is mapping and acdc.e.keys() | list | length > 0 %}
    <details>
        <summary>Edges (Links to other credentials)</summary>
        <ul>
        {% for key, edge in acdc.e.items() %}
            {% if edge is mapping and edge.n %}
            <li><strong>{{ key }}:</strong> <code style="font-size:0.8em;">{{ edge.n[:24] }}...</code></li>
            {% endif %}
        {% endfor %}
        </ul>
    </details>
    {% endif %}
</article>

{% endif %}
