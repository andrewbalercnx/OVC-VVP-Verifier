{# Enhanced credential card partial #}
{#
   Accepts either:
   - vm: CredentialCardViewModel (new view-model, preferred)
   - acdc: Raw ACDC dict (legacy, for backwards compatibility)

   When using view-model (vm), provides:
   - Normalized primary/secondary attributes
   - Lazy revocation badge loading
   - Chain expansion with availability checks
   - Variant limitation banners
#}

{% if vm %}
{# ===== NEW VIEW-MODEL PATH ===== #}

{% set status_class = 'valid' if vm.status == 'VALID' else ('invalid' if vm.status == 'INVALID' else 'indeterminate') %}

<article class="credential-card {{ status_class }}" id="cred-{{ vm.said }}" data-said="{{ vm.said }}">
  <header style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem;">
    <span>
      {# Credential type badge #}
      <span class="badge badge-{{ vm.credential_type | lower }}">{{ vm.credential_type }}</span>

      {# Primary attribute or truncated SAID #}
      <strong class="credential-primary">{{ vm.primary.value }}</strong>
    </span>

    <span>
      {# Status badge #}
      {% if vm.status == 'VALID' %}
      <span class="badge badge-success">{{ vm.status }}</span>
      {% elif vm.status == 'INVALID' %}
      <span class="badge badge-danger">{{ vm.status }}</span>
      {% else %}
      <span class="badge badge-warning">{{ vm.status }}</span>
      {% endif %}

      {# Trusted root indicator #}
      {% if vm.issuer.is_trusted_root %}
      <span class="badge badge-root" title="Trusted Root AID">ROOT</span>
      {% endif %}
    </span>
  </header>

  {# Variant limitation banner #}
  {% if vm.limitations.has_variant_limitations %}
  <div class="credential-limitation-banner">
    {% if vm.limitations.is_compact %}
      <small>Compact encoding - attributes not expanded</small>
    {% elif vm.limitations.is_partial %}
      <small>Partial data - some fields redacted</small>
    {% endif %}
  </div>
  {% endif %}

  {# vCard Brand Display - Logo and Organization #}
  {% if vm.vcard and (vm.vcard.logo_url or vm.vcard.org) %}
  <div class="vcard-brand" style="display:flex;align-items:center;gap:1rem;margin:0.75rem 0;padding:0.75rem;background:var(--vvp-bg-subtle, #f8f9fa);border-radius:0.5rem;">
    {% if vm.vcard.logo_url %}
    <img src="{{ vm.vcard.logo_url }}"
         alt="{{ vm.vcard.org or 'Organization Logo' }}"
         class="vcard-logo"
         style="max-width:80px;max-height:60px;object-fit:contain;"
         onerror="this.style.display='none';">
    {% endif %}
    <div class="vcard-info">
      {% if vm.vcard.org %}
      <div class="vcard-org" style="font-weight:600;">{{ vm.vcard.org }}</div>
      {% endif %}
      {% if vm.vcard.lei %}
      <div class="vcard-lei" style="font-size:0.85em;color:var(--vvp-text-muted, #6c757d);">LEI: {{ vm.vcard.lei }}</div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {# Core identifiers - always visible #}
  <dl class="attrs-grid">
    <dt title="SAID (Self-Addressing Identifier): Self-referential cryptographic digest that uniquely identifies this ACDC." class="has-tooltip">SAID</dt>
    <dd><code style="font-size:0.8em;word-break:break-all;">{{ vm.said }}</code></dd>

    <dt title="Issuer AID: Autonomic Identifier of the issuer, established via KERI Key State." class="has-tooltip">Issuer</dt>
    <dd>
      {% if vm.issuer.display_name %}
      <span style="font-weight:600;">{{ vm.issuer.display_name }}</span>
      <br><code style="font-size:0.75em;color:var(--vvp-text-muted, #6c757d);word-break:break-all;">{{ vm.issuer.aid_short }}</code>
      {% if vm.issuer.lei %}
      <br><span style="font-size:0.8em;color:var(--vvp-text-muted, #6c757d);">LEI: {{ vm.issuer.lei }}</span>
      {% endif %}
      {% else %}
      <code style="font-size:0.8em;word-break:break-all;">{{ vm.issuer.aid_short }}</code>
      {% endif %}
    </dd>
  </dl>

  {# Attribute sections (collapsible, grouped by category) #}
  {% if vm.sections %}
  <div class="credential-attributes">
    {% for section in vm.sections %}
    <details open class="{{ section.css_class }}">
      <summary>
        {{ section.name }}
        <span class="badge badge-muted">{{ section.attributes | length }}</span>
      </summary>
      <dl class="attrs-grid">
        {% for attr in section.attributes %}
        <dt {% if attr.tooltip %}title="{{ attr.tooltip }}" class="has-tooltip"{% endif %}>{{ attr.label }}</dt>
        <dd class="{{ attr.css_class }}">{{ attr.value }}</dd>
        {% endfor %}
      </dl>
    </details>
    {% endfor %}
  </div>
  {% endif %}

  <div class="card-meta" style="display:flex;justify-content:space-between;align-items:center;margin-top:0.5rem;">
    <small>Schema: <code style="font-size:0.8em;">{{ vm.schema_said[:16] }}...</code></small>

    {# Revocation status badge - displayed inline #}
    <span class="revocation-badge">
      {% if vm.revocation.state == 'ACTIVE' %}
      <span class="badge badge-success" title="Credential is active{% if vm.revocation.checked_at %} (checked {{ vm.revocation.checked_at }}){% endif %}">ACTIVE</span>
      {% elif vm.revocation.state == 'REVOKED' %}
      <span class="badge badge-danger" title="Credential has been revoked{% if vm.revocation.checked_at %} (checked {{ vm.revocation.checked_at }}){% endif %}">REVOKED</span>
      {% else %}
      <span class="badge badge-warning" title="Revocation status unknown{% if vm.revocation.error %}: {{ vm.revocation.error }}{% endif %}">UNKNOWN</span>
      {% endif %}
    </span>
  </div>

  {# Chain expansion links #}
  {% if vm.edges %}
  <footer style="margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid #dee2e6;">
    {% for key, edge in vm.edges.items() %}
      {% if edge.said %}
        {% if edge.available %}
        <a href="#cred-{{ edge.said }}"
           class="edge-link"
           onclick="highlightCredential('{{ edge.said }}'); return false;"
           style="margin-right:0.5rem;">
          {{ edge.label }} &rarr;
        </a>
        {% else %}
        <span class="edge-unavailable" title="Credential not in dossier">
          {{ edge.label }} (unavailable)
        </span>
        {% endif %}
      {% endif %}
    {% endfor %}
  </footer>
  {% endif %}

  {# Raw Contents section - collapsible with tooltips #}
  <details class="raw-contents-section" style="margin-top:0.5rem;">
    <summary>Raw Contents</summary>
    {% if vm.raw_contents %}
    <dl class="attrs-grid raw-contents-grid">
      {% for attr in vm.raw_contents %}
      <dt {% if attr.tooltip %}title="{{ attr.tooltip }}" class="has-tooltip"{% endif %}>{{ attr.label }}</dt>
      <dd class="{{ attr.css_class }}">
        {% if attr.css_class == 'attr-object' %}
        <span class="attr-object-marker">{...}</span>
        {% else %}
        <code style="font-size:0.85em;word-break:break-all;">{{ attr.value }}</code>
        {% endif %}
      </dd>
      {% endfor %}
    </dl>
    {% else %}
    <div class="code-block">{{ vm.raw.attributes | tojson(indent=2) }}</div>
    {% endif %}
  </details>

  {# Chain expansion container #}
  <div id="chain-{{ vm.said }}" class="credential-layer"></div>
</article>

{% else %}
{# ===== LEGACY RAW ACDC PATH (backwards compatibility) ===== #}

{% set cred_type = acdc.type or 'UNKNOWN' %}
{% set status = acdc.status or 'UNKNOWN' %}
{% set is_valid = status == 'ACTIVE' or status == 'VALID' %}
{% set is_invalid = status == 'REVOKED' or status == 'INVALID' %}

<article class="credential-card {% if is_valid %}valid{% elif is_invalid %}invalid{% else %}unknown{% endif %}" id="cred-{{ acdc.d }}" data-said="{{ acdc.d }}">
    <header style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem;">
        <span>
            {# Credential type badge #}
            {% if cred_type == 'ROOT' %}
            <span class="badge badge-root">ROOT</span>
            {% elif cred_type == 'ISSUER' %}
            <span class="badge badge-issuer">ISSUER</span>
            {% elif cred_type == 'LE' %}
            <span class="badge badge-le">LE</span>
            {% elif cred_type == 'APE' %}
            <span class="badge badge-ape">APE</span>
            {% elif cred_type == 'DE' %}
            <span class="badge badge-de">DE</span>
            {% elif cred_type == 'TNAlloc' %}
            <span class="badge badge-tnalloc">TNAlloc</span>
            {% else %}
            <span class="badge badge-muted">{{ cred_type }}</span>
            {% endif %}

            {# Display name or SAID #}
            {% if acdc.displayName %}
            <strong>{{ acdc.displayName }}</strong>
            {% else %}
            <strong>{{ acdc.d[:16] }}...</strong>
            {% endif %}
        </span>

        {# Status badge #}
        {% if status == 'ACTIVE' or status == 'VALID' %}
        <span class="badge badge-success">{{ status }}</span>
        {% elif status == 'REVOKED' %}
        <span class="badge badge-danger">REVOKED</span>
        {% elif status == 'UNKNOWN' %}
        <span class="badge badge-warning">UNKNOWN</span>
        {% else %}
        <span class="badge badge-muted">{{ status }}</span>
        {% endif %}
    </header>

    <dl>
        <dt>SAID</dt>
        <dd><code style="font-size:0.8em;word-break:break-all;">{{ acdc.d }}</code></dd>

        {% if acdc.i %}
        <dt>Issuer AID</dt>
        <dd><code style="font-size:0.8em;word-break:break-all;">{{ acdc.i }}</code></dd>
        {% endif %}

        {% if acdc.s %}
        <dt>Schema SAID</dt>
        <dd><code style="font-size:0.8em;">{{ acdc.s[:24] }}...</code></dd>
        {% endif %}
    </dl>

    {# Attributes section #}
    {% if acdc.a and acdc.a is mapping %}
    <details>
        <summary>Attributes</summary>
        {% if acdc.a.vcard %}
        <h5>vCard</h5>
        <ul>
            {% for line in acdc.a.vcard %}
            <li><code>{{ line }}</code></li>
            {% endfor %}
        </ul>
        {% endif %}

        {% if acdc.a.legalName %}
        <p><strong>Legal Name:</strong> {{ acdc.a.legalName }}</p>
        {% endif %}

        {% if acdc.a.LEI or acdc.a.lids %}
        <p><strong>LEI:</strong> {{ acdc.a.LEI or acdc.a.lids[0] }}</p>
        {% endif %}

        {% if acdc.a.tn %}
        <p><strong>Telephone Numbers:</strong>
            {% if acdc.a.tn is string %}
                {{ acdc.a.tn }}
            {% else %}
                {{ acdc.a.tn | join(', ') }}
            {% endif %}
        </p>
        {% endif %}

        <details>
            <summary>Raw Attributes</summary>
            <div class="code-block">{{ acdc.a | tojson(indent=2) }}</div>
        </details>
    </details>
    {% endif %}

    {# Edges section #}
    {% if acdc.e and acdc.e is mapping and acdc.e.keys() | list | length > 0 %}
    <details>
        <summary>Edges (Links to other credentials)</summary>
        <ul>
        {% for key, edge in acdc.e.items() %}
            {% if edge is mapping and edge.n %}
            <li><strong>{{ key }}:</strong> <code style="font-size:0.8em;">{{ edge.n[:24] }}...</code></li>
            {% endif %}
        {% endfor %}
        </ul>
    </details>
    {% endif %}
</article>

{% endif %}
