<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VVP Issuer - Identities</title>
    <link rel="stylesheet" href="/static/styles.css">
  </head>
  <body>
    <header class="site-header">
      <div class="header-brand">
        <img src="/static/ovc-logo.png" alt="OVC" class="ovc-logo">
        <a href="/ui/" class="logo">
          <span class="service-label">VVP</span>
          Issuer
        </a>
      </div>
      <nav class="nav-links">
        <a href="/ui/identity" class="active">Identities</a>
        <a href="/ui/registry">Registries</a>
        <a href="/ui/schemas">Schemas</a>
        <a href="/ui/credentials">Credentials</a>
        <a href="/ui/dossier">Dossiers</a>
        <a href="/ui/admin">Admin</a>
        <a href="https://vvp-verifier.rcnx.io" class="verifier-link" target="_blank">Verifier ↗</a>
      </nav>
    </header>

    <h1>Identity Management</h1>
    <p class="subtitle">Create and manage KERI identities for credential issuance</p>

    <div class="card">
      <h2>Create New Identity</h2>
      <form id="createForm">
        <div style="margin-bottom: 1rem;">
          <label for="name">Identity Name</label>
          <input type="text" id="name" name="name" placeholder="e.g., my-issuer" required>
        </div>

        <div class="checkbox-row">
          <input type="checkbox" id="transferable" name="transferable" checked>
          <label for="transferable">Transferable (keys can rotate)</label>
        </div>

        <div class="checkbox-row">
          <input type="checkbox" id="publishToWitnesses" name="publishToWitnesses" checked>
          <label for="publishToWitnesses">Publish to witnesses</label>
        </div>

        <button type="submit" id="createBtn">Create Identity</button>
      </form>

      <div id="createResult"></div>
    </div>

    <div class="card">
      <h2>Existing Identities</h2>
      <button id="refreshBtn" style="margin-bottom: 1rem; background: #6c757d;">Refresh List</button>
      <div id="identityList">
        <em>Loading...</em>
      </div>
    </div>

    <script>
      const createForm = document.getElementById('createForm');
      const createBtn = document.getElementById('createBtn');
      const createResult = document.getElementById('createResult');
      const identityList = document.getElementById('identityList');
      const refreshBtn = document.getElementById('refreshBtn');

      // Create identity
      createForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        createBtn.disabled = true;
        createBtn.innerHTML = '<span class="spinner"></span>Creating...';
        createResult.innerHTML = '';

        const name = document.getElementById('name').value.trim();
        const transferable = document.getElementById('transferable').checked;
        const publishToWitnesses = document.getElementById('publishToWitnesses').checked;

        try {
          const res = await fetch('/identity', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
              name,
              transferable,
              publish_to_witnesses: publishToWitnesses
            })
          });

          const data = await res.json();

          if (!res.ok) {
            createResult.innerHTML = `<div class="error">Error: ${data.detail || 'Unknown error'}</div>`;
            return;
          }

          const identity = data.identity;
          let html = `<div class="success">
            <strong>Identity Created Successfully!</strong>
            <div class="result-field">
              <strong>Name:</strong>
              <code>${identity.name}</code>
            </div>
            <div class="result-field">
              <strong>AID (Autonomic Identifier):</strong>
              <code>${identity.aid}</code>
            </div>
            <div class="result-field">
              <strong>Transferable:</strong>
              <code>${identity.transferable ? 'Yes' : 'No'}</code>
            </div>
            <div class="result-field">
              <strong>Witnesses:</strong>
              <code>${identity.witness_count}</code>
            </div>
          </div>`;

          if (data.oobi_urls && data.oobi_urls.length > 0) {
            html += `<div class="card" style="margin-top:1rem;background:#e8f4ff;">
              <h3 style="margin-top:0;">OOBI URLs</h3>
              <p style="font-size:0.85rem;color:#666;">Share these URLs for others to discover this identity:</p>`;
            for (const url of data.oobi_urls) {
              html += `<div class="oobi-url">
                <code>${url}</code>
                <button class="copy-btn" onclick="copyToClipboard('${url}', this)">Copy</button>
              </div>`;
            }
            html += `</div>`;
          }

          if (data.publish_results && data.publish_results.length > 0) {
            const successCount = data.publish_results.filter(r => r.success).length;
            html += `<div class="publish-results">
              <strong>Witness Publishing:</strong> ${successCount}/${data.publish_results.length} succeeded`;
            for (const result of data.publish_results) {
              const cls = result.success ? 'witness-success' : 'witness-fail';
              const icon = result.success ? '✓' : '✗';
              html += `<div class="witness-result ${cls}">
                ${icon} ${result.url}${result.error ? ` (${result.error})` : ''}
              </div>`;
            }
            html += `</div>`;
          }

          createResult.innerHTML = html;
          document.getElementById('name').value = '';
          loadIdentities();

        } catch (err) {
          createResult.innerHTML = `<div class="error">Network error: ${err.message}</div>`;
        } finally {
          createBtn.disabled = false;
          createBtn.textContent = 'Create Identity';
        }
      });

      // Load identities
      async function loadIdentities() {
        identityList.innerHTML = '<em>Loading...</em>';

        try {
          const res = await fetch('/identity');
          const data = await res.json();

          if (!res.ok) {
            if (res.status === 401) {
              identityList.innerHTML = '<div class="error">Authentication required. Set VVP_AUTH_ENABLED=false for local development.</div>';
            } else {
              identityList.innerHTML = `<div class="error">Error: ${data.detail || res.statusText}</div>`;
            }
            return;
          }

          if (data.count === 0) {
            identityList.innerHTML = '<em>No identities created yet.</em>';
            return;
          }

          let html = '<div class="identity-list">';
          for (const identity of data.identities) {
            const badge = identity.transferable
              ? '<span class="badge badge-transferable">Transferable</span>'
              : '<span class="badge badge-non-transferable">Non-transferable</span>';

            const rotateBtn = identity.transferable
              ? `<button onclick="rotateIdentity('${identity.aid}', '${identity.name}')" style="margin-top:0.5rem;margin-left:0.5rem;padding:0.25rem 0.5rem;font-size:0.85rem;background:#ffc107;color:#000;">Rotate Keys</button>`
              : `<button disabled style="margin-top:0.5rem;margin-left:0.5rem;padding:0.25rem 0.5rem;font-size:0.85rem;background:#ccc;color:#666;cursor:not-allowed;" title="Non-transferable identities cannot rotate keys">Rotate Keys</button>`;

            html += `<div class="identity-item">
              <h4>${identity.name} ${badge}</h4>
              <div class="aid">${identity.aid}</div>
              <div class="identity-meta">
                <span>Keys: ${identity.key_count}</span>
                <span>Witnesses: ${identity.witness_count}</span>
                <span>Seq: ${identity.sequence_number}</span>
              </div>
              <div>
                <button onclick="showOobi('${identity.aid}')" style="margin-top:0.5rem;padding:0.25rem 0.5rem;font-size:0.85rem;background:#17a2b8;">View OOBI URLs</button>
                ${rotateBtn}
                <button onclick="deleteIdentity('${identity.aid}', '${identity.name}')" style="margin-top:0.5rem;margin-left:0.5rem;padding:0.25rem 0.5rem;font-size:0.85rem;background:#dc3545;">Delete</button>
              </div>
            </div>`;
          }
          html += '</div>';
          identityList.innerHTML = html;

        } catch (err) {
          identityList.innerHTML = `<div class="error">Failed to load: ${err.message}</div>`;
        }
      }

      // Show OOBI URLs for an identity
      async function showOobi(aid) {
        try {
          const res = await fetch(`/identity/${aid}/oobi`);
          const data = await res.json();

          let html = '<h4>OOBI URLs for ' + aid.substring(0, 16) + '...</h4>';
          for (const url of data.oobi_urls) {
            html += `<div class="oobi-url">
              <code>${url}</code>
              <button class="copy-btn" onclick="copyToClipboard('${url}', this)">Copy</button>
            </div>`;
          }

          const modal = document.createElement('div');
          modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000;';
          modal.innerHTML = `<div style="background:white;padding:1.5rem;border-radius:8px;max-width:600px;max-height:80vh;overflow:auto;">
            ${html}
            <button onclick="this.closest('div').parentElement.remove()" style="margin-top:1rem;background:#6c757d;">Close</button>
          </div>`;
          modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
          document.body.appendChild(modal);

        } catch (err) {
          alert('Failed to load OOBI URLs: ' + err.message);
        }
      }

      // Rotate identity keys
      async function rotateIdentity(aid, name) {
        if (!confirm(`Are you sure you want to rotate keys for "${name}"?\n\nThis action cannot be undone. The current signing keys will be replaced with new ones.`)) {
          return;
        }

        // Show loading modal
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000;';
        modal.innerHTML = `<div style="background:white;padding:1.5rem;border-radius:8px;max-width:600px;text-align:center;">
          <span class="spinner"></span> Rotating keys...
        </div>`;
        document.body.appendChild(modal);

        try {
          const res = await fetch(`/identity/${aid}/rotate`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ publish_to_witnesses: true })
          });

          const data = await res.json();

          if (!res.ok) {
            modal.innerHTML = `<div style="background:white;padding:1.5rem;border-radius:8px;max-width:600px;">
              <div class="error">
                <strong>Rotation Failed</strong><br>
                ${data.detail || 'Unknown error'}
              </div>
              <button onclick="this.closest('div').parentElement.remove()" style="margin-top:1rem;background:#6c757d;">Close</button>
            </div>`;
            return;
          }

          // Build success message
          let html = `<div class="success">
            <strong>Keys Rotated Successfully!</strong>
            <div class="result-field">
              <strong>Identity:</strong>
              <code>${data.identity.name}</code>
            </div>
            <div class="result-field">
              <strong>Previous Sequence:</strong>
              <code>${data.previous_sequence_number}</code>
            </div>
            <div class="result-field">
              <strong>New Sequence:</strong>
              <code>${data.identity.sequence_number}</code>
            </div>
          </div>`;

          // Per-witness publish results
          if (data.publish_results && data.publish_results.length > 0) {
            const successCount = data.publish_results.filter(r => r.success).length;
            const thresholdClass = data.publish_threshold_met ? '' : 'style="color:#dc3545;"';
            html += `<div class="publish-results">
              <strong ${thresholdClass}>Witness Publishing:</strong> ${successCount}/${data.publish_results.length} succeeded`;

            if (!data.publish_threshold_met) {
              html += `<div style="color:#dc3545;margin:0.5rem 0;"><strong>Warning:</strong> Witness threshold not met. Some witnesses may not have the rotation event.</div>`;
            }

            for (const result of data.publish_results) {
              const cls = result.success ? 'witness-success' : 'witness-fail';
              const icon = result.success ? '✓' : '✗';
              html += `<div class="witness-result ${cls}">
                ${icon} ${result.witness_url}${result.error ? ` (${result.error})` : ''}
              </div>`;
            }
            html += `</div>`;
          }

          modal.innerHTML = `<div style="background:white;padding:1.5rem;border-radius:8px;max-width:600px;max-height:80vh;overflow:auto;">
            ${html}
            <button onclick="this.closest('div').parentElement.remove()" style="margin-top:1rem;background:#6c757d;">Close</button>
          </div>`;

          // Refresh the identity list
          loadIdentities();

        } catch (err) {
          modal.innerHTML = `<div style="background:white;padding:1.5rem;border-radius:8px;max-width:600px;">
            <div class="error">Network error: ${err.message}</div>
            <button onclick="this.closest('div').parentElement.remove()" style="margin-top:1rem;background:#6c757d;">Close</button>
          </div>`;
        }
      }

      // Delete identity
      async function deleteIdentity(aid, name) {
        if (!confirm(`Are you sure you want to delete "${name}"?\n\nThis removes the identity from local storage only. The identity still exists in the KERI ecosystem (witnesses, watchers, etc.).`)) {
          return;
        }

        // Show loading modal
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000;';
        modal.innerHTML = `<div style="background:white;padding:1.5rem;border-radius:8px;max-width:600px;text-align:center;">
          <span class="spinner"></span> Deleting identity...
        </div>`;
        document.body.appendChild(modal);

        try {
          const res = await fetch(`/identity/${aid}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest'
            }
          });

          const data = await res.json();

          if (!res.ok) {
            modal.innerHTML = `<div style="background:white;padding:1.5rem;border-radius:8px;max-width:600px;">
              <div class="error">
                <strong>Deletion Failed</strong><br>
                ${data.detail || 'Unknown error'}
              </div>
              <button onclick="this.closest('div').parentElement.remove()" style="margin-top:1rem;background:#6c757d;">Close</button>
            </div>`;
            return;
          }

          modal.innerHTML = `<div style="background:white;padding:1.5rem;border-radius:8px;max-width:600px;">
            <div class="success">
              <strong>Identity Deleted</strong><br>
              ${data.message || 'Identity removed from local storage.'}
            </div>
            <button onclick="this.closest('div').parentElement.remove()" style="margin-top:1rem;background:#6c757d;">Close</button>
          </div>`;

          // Refresh the identity list
          loadIdentities();

        } catch (err) {
          modal.innerHTML = `<div style="background:white;padding:1.5rem;border-radius:8px;max-width:600px;">
            <div class="error">Network error: ${err.message}</div>
            <button onclick="this.closest('div').parentElement.remove()" style="margin-top:1rem;background:#6c757d;">Close</button>
          </div>`;
        }
      }

      // Copy to clipboard
      function copyToClipboard(text, btn) {
        navigator.clipboard.writeText(text).then(() => {
          const orig = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(() => btn.textContent = orig, 1500);
        });
      }

      // Refresh button
      refreshBtn.addEventListener('click', loadIdentities);

      // Initial load
      loadIdentities();
    </script>
    <script src="/static/shared.js"></script>
  </body>
</html>
