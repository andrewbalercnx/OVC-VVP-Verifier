<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VVP Integration Test Benchmarks</title>
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        .benchmark-card {
            background: var(--surface-color, #f5f5f5);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .metric-box {
            background: white;
            border-radius: 4px;
            padding: 1rem;
            text-align: center;
        }
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.875rem;
            color: #666;
        }
        .status-pass {
            color: #2e7d32;
        }
        .status-fail {
            color: #c62828;
        }
        .threshold-info {
            font-size: 0.75rem;
            color: #888;
            margin-top: 0.25rem;
        }
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .history-table th, .history-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .history-table th {
            background: #f0f0f0;
        }
        .no-data {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
    </style>
</head>
<body>
    <header>
        <h1>VVP Integration Test Benchmarks</h1>
        <nav>
            <a href="/create">Create Identity</a>
            <a href="/registry/ui">Registries</a>
            <a href="/schemas/ui">Schemas</a>
            <a href="/credentials/ui">Credentials</a>
            <a href="/dossier/ui">Dossiers</a>
            <a href="/admin/benchmarks/ui" class="active">Benchmarks</a>
        </nav>
    </header>

    <main>
        <section id="loading">
            <p>Loading benchmark results...</p>
        </section>

        <section id="no-data" style="display: none;">
            <div class="no-data">
                <h3>No Benchmark Results</h3>
                <p>Run integration tests to generate benchmark data:</p>
                <pre>./scripts/run-integration-tests.sh --local</pre>
            </div>
        </section>

        <section id="results" style="display: none;">
            <h2>Latest Results</h2>
            <p id="latest-info"></p>

            <div id="benchmark-cards"></div>

            <h2>History (Last 10 Runs)</h2>
            <table class="history-table" id="history-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Mode</th>
                        <th>Single Cred (p95)</th>
                        <th>Chained (p95)</th>
                        <th>Concurrent (p95)</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                </tbody>
            </table>
        </section>
    </main>

    <script>
        async function loadBenchmarks() {
            try {
                const response = await fetch('/admin/benchmarks', {
                    headers: {
                        'X-API-Key': localStorage.getItem('vvp_api_key') || ''
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        document.getElementById('loading').innerHTML = `
                            <div class="no-data">
                                <h3>Authentication Required</h3>
                                <p>Enter your API key to view benchmark results.</p>
                                <input type="password" id="api-key-input" placeholder="API Key">
                                <button onclick="saveApiKey()">Save</button>
                            </div>
                        `;
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                document.getElementById('loading').style.display = 'none';

                if (!data.latest) {
                    document.getElementById('no-data').style.display = 'block';
                    return;
                }

                document.getElementById('results').style.display = 'block';

                // Show latest info
                const latestInfo = document.getElementById('latest-info');
                latestInfo.textContent = `Run at ${data.latest.timestamp} (mode: ${data.latest.mode})`;

                // Build benchmark cards
                const cardsContainer = document.getElementById('benchmark-cards');
                cardsContainer.innerHTML = '';

                for (const [testName, metrics] of Object.entries(data.latest.tests)) {
                    const threshold = data.thresholds[testName];
                    const p95Pass = threshold ? metrics.p95 < threshold.p95_target : true;
                    const p99Pass = threshold ? metrics.p99 < threshold.p99_max : true;

                    const card = document.createElement('div');
                    card.className = 'benchmark-card';
                    card.innerHTML = `
                        <h3>${formatTestName(testName)}</h3>
                        <div class="metric-grid">
                            <div class="metric-box">
                                <div class="metric-value">${metrics.count}</div>
                                <div class="metric-label">Iterations</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-value">${metrics.p50.toFixed(3)}s</div>
                                <div class="metric-label">p50 (median)</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-value ${p95Pass ? 'status-pass' : 'status-fail'}">${metrics.p95.toFixed(3)}s</div>
                                <div class="metric-label">p95</div>
                                ${threshold ? `<div class="threshold-info">target: &lt; ${threshold.p95_target}s</div>` : ''}
                            </div>
                            <div class="metric-box">
                                <div class="metric-value ${p99Pass ? 'status-pass' : 'status-fail'}">${metrics.p99.toFixed(3)}s</div>
                                <div class="metric-label">p99</div>
                                ${threshold ? `<div class="threshold-info">max: &lt; ${threshold.p99_max}s</div>` : ''}
                            </div>
                            <div class="metric-box">
                                <div class="metric-value">${metrics.min.toFixed(3)}s</div>
                                <div class="metric-label">Min</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-value">${metrics.max.toFixed(3)}s</div>
                                <div class="metric-label">Max</div>
                            </div>
                        </div>
                    `;
                    cardsContainer.appendChild(card);
                }

                // Build history table
                const historyBody = document.getElementById('history-body');
                historyBody.innerHTML = '';

                for (const run of data.history) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${run.timestamp}</td>
                        <td>${run.mode}</td>
                        <td>${run.tests.single_credential ? run.tests.single_credential.p95.toFixed(3) + 's' : '-'}</td>
                        <td>${run.tests.chained_credential ? run.tests.chained_credential.p95.toFixed(3) + 's' : '-'}</td>
                        <td>${run.tests.concurrent_verification ? run.tests.concurrent_verification.p95.toFixed(3) + 's' : '-'}</td>
                    `;
                    historyBody.appendChild(row);
                }

            } catch (error) {
                document.getElementById('loading').innerHTML = `
                    <div class="no-data">
                        <h3>Error Loading Benchmarks</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function formatTestName(name) {
            return name.split('_').map(word =>
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function saveApiKey() {
            const key = document.getElementById('api-key-input').value;
            if (key) {
                localStorage.setItem('vvp_api_key', key);
                loadBenchmarks();
            }
        }

        loadBenchmarks();
    </script>
</body>
</html>
