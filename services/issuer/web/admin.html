<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - VVP Issuer</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    .admin-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .status-card {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .status-label {
      font-size: 0.85em;
      color: var(--vvp-muted);
      text-transform: uppercase;
    }
    .status-value {
      font-size: 1.1em;
      font-weight: 500;
    }
    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }
    .status-dot.healthy { background: var(--vvp-success); }
    .status-dot.error { background: var(--vvp-danger); }
    .status-dot.loading { background: var(--vvp-warning); animation: pulse 1s infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .config-section {
      background: white;
      margin: 1rem 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .config-section > summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background: #f8f9fa;
      cursor: pointer;
      border-bottom: 1px solid transparent;
    }
    .config-section[open] > summary {
      border-bottom: 1px solid #dee2e6;
    }
    .section-title {
      font-weight: 600;
    }
    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 0.75rem;
      padding: 1rem;
    }
    .config-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background: #f8f9fa;
      border-radius: 0.25rem;
    }
    .config-key {
      font-weight: 500;
      color: var(--vvp-muted);
    }
    .config-value {
      font-family: monospace;
      font-size: 0.95em;
    }
    .config-value.path {
      font-size: 0.85em;
      word-break: break-all;
    }

    .admin-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .admin-controls select {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      border: 1px solid #dee2e6;
    }
    .admin-controls button {
      padding: 0.25rem 0.75rem;
      font-size: 0.9em;
    }

    .witness-list {
      font-family: monospace;
      font-size: 0.85em;
      max-height: 200px;
      overflow-y: auto;
      background: #f6f6f6;
      padding: 0.5rem;
      border-radius: 4px;
      margin: 0;
      list-style-position: inside;
    }
    .witness-list li {
      padding: 0.25rem 0;
      border-bottom: 1px solid #eee;
    }
    .witness-list li:last-child {
      border-bottom: none;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      padding: 1rem;
    }
    .stat-item {
      text-align: center;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--vvp-primary);
    }
    .stat-label {
      font-size: 0.9em;
      color: var(--vvp-muted);
    }

    /* Deployment test styles */
    .deployment-status {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    .deployment-status.passed {
      background: #d4edda;
      border: 1px solid #c3e6cb;
    }
    .deployment-status.failed {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
    }
    .deployment-status.unknown {
      background: #e2e3e5;
      border: 1px solid #d6d8db;
    }
    .deployment-icon {
      font-size: 2rem;
    }
    .deployment-details {
      flex: 1;
    }
    .deployment-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .deployment-meta {
      font-size: 0.85em;
      color: var(--vvp-muted);
    }
    .deployment-stats {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    .deployment-stat {
      font-size: 0.9em;
    }
    .deployment-stat strong {
      color: var(--vvp-primary);
    }
    .test-history {
      margin-top: 1rem;
    }
    .test-history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      border-bottom: 1px solid #eee;
    }
    .test-history-item:last-child {
      border-bottom: none;
    }
    .test-history-sha {
      font-family: monospace;
      font-size: 0.85em;
    }
    .test-history-result {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .test-history-result .badge {
      font-size: 0.75em;
    }

    .auth-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      padding: 1rem;
    }
    .auth-item {
      text-align: center;
      padding: 0.5rem;
    }
    .auth-value {
      font-size: 1.5rem;
      font-weight: bold;
    }
    .auth-label {
      font-size: 0.85em;
      color: var(--vvp-muted);
    }

    /* User Management Styles */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th,
    .data-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }
    .data-table th {
      background: #f8f9fa;
      font-weight: 600;
      font-size: 0.9em;
      color: var(--vvp-muted);
    }
    .data-table tbody tr:hover {
      background: #f8f9fa;
    }
    .data-table .actions {
      display: flex;
      gap: 0.5rem;
    }
    .data-table .actions button {
      padding: 0.25rem 0.5rem;
      font-size: 0.85em;
    }
    .badge-enabled {
      background: var(--vvp-success);
      color: white;
    }
    .badge-disabled {
      background: var(--vvp-muted);
      color: white;
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #dee2e6;
    }
    .modal-header h3 {
      margin: 0;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      color: var(--vvp-muted);
    }
    .modal-close:hover {
      color: var(--vvp-danger);
    }

    /* Form Styles */
    .form-group {
      padding: 0 1rem;
      margin-bottom: 1rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.25rem;
      font-weight: 500;
    }
    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group input[type="password"] {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-size: 1rem;
    }
    .form-group small {
      display: block;
      margin-top: 0.25rem;
      color: var(--vvp-muted);
      font-size: 0.85em;
    }
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: normal;
    }
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      padding: 1rem;
      border-top: 1px solid #dee2e6;
      margin-top: 1rem;
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-secondary:hover {
      background: #5a6268;
    }
    .btn-primary {
      background: var(--vvp-primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-primary:hover {
      opacity: 0.9;
    }
    .btn-danger {
      background: var(--vvp-danger);
      color: white;
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
    }
    .btn-danger:hover {
      opacity: 0.9;
    }

    /* Audit Log Styles */
    .audit-filter-bar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .audit-filter-bar select {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      border: 1px solid #dee2e6;
    }
    .audit-log-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
    }
    .audit-log-table th,
    .audit-log-table td {
      padding: 0.5rem;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }
    .audit-log-table th {
      background: #f8f9fa;
      font-weight: 600;
      font-size: 0.85em;
      color: var(--vvp-muted);
    }
    .audit-log-table tbody tr:hover {
      background: #f8f9fa;
    }
    .audit-log-table .status-success { color: var(--vvp-success); }
    .audit-log-table .status-denied { color: var(--vvp-danger); }
    .audit-log-table .status-error { color: var(--vvp-danger); }
    .audit-log-table .status-revoked { color: var(--vvp-warning); }
    .audit-log-table .timestamp {
      font-family: monospace;
      font-size: 0.85em;
      white-space: nowrap;
    }
    .audit-log-table .action {
      font-family: monospace;
    }
    .audit-log-table .details {
      max-width: 300px;
      font-family: monospace;
      font-size: 0.8em;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .audit-buffer-info {
      font-size: 0.85em;
      color: var(--vvp-muted);
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-brand">
      <img src="/static/ovc-logo.png" alt="OVC" class="ovc-logo">
      <a href="/ui/" class="logo">
        <span class="service-label">VVP</span>
        Issuer
      </a>
    </div>
    <nav class="nav-links">
      <a href="/ui/identity">Identities</a>
      <a href="/ui/registry">Registries</a>
      <a href="/ui/schemas">Schemas</a>
      <a href="/ui/credentials">Credentials</a>
      <a href="/ui/dossier">Dossiers</a>
      <a href="/ui/vvp">VVP Headers</a>
      <a href="/ui/help">Help</a>
      <a href="/ui/admin" class="active">Admin</a>
      <a href="https://vvp-verifier.rcnx.io" class="verifier-link" target="_blank">Verifier â†—</a>
    </nav>
  </header>

  <main>
    <h1>Admin Dashboard</h1>
    <p class="lead">Service configuration and runtime controls for VVP Issuer operators.</p>

    <!-- Service Status -->
    <section id="service-status">
      <h2>Service Status</h2>
      <div class="admin-grid">
        <div class="status-card">
          <span class="status-label">Health</span>
          <span id="health-status" class="status-value">
            <span class="status-dot loading"></span> Loading...
          </span>
        </div>
        <div class="status-card">
          <span class="status-label">Version</span>
          <span id="version-value" class="status-value">Loading...</span>
        </div>
        <div class="status-card">
          <span class="status-label">Log Level</span>
          <div class="admin-controls">
            <select id="log-level-select">
              <option value="DEBUG">DEBUG</option>
              <option value="INFO">INFO</option>
              <option value="WARNING">WARNING</option>
              <option value="ERROR">ERROR</option>
              <option value="CRITICAL">CRITICAL</option>
            </select>
            <button onclick="setLogLevel()">Apply</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Deployment Test Results -->
    <details class="config-section" open>
      <summary>
        <span class="section-title">Deployment Tests</span>
        <span class="badge" id="deployment-badge">Loading...</span>
      </summary>
      <div style="padding: 1rem;">
        <div id="deployment-status" class="deployment-status unknown">
          <span class="deployment-icon" id="deployment-icon">?</span>
          <div class="deployment-details">
            <div class="deployment-title" id="deployment-title">No test results</div>
            <div class="deployment-meta" id="deployment-meta">Run deployment tests to see results</div>
            <div class="deployment-stats" id="deployment-stats" style="display: none;">
              <span class="deployment-stat"><strong id="tests-passed">0</strong> passed</span>
              <span class="deployment-stat"><strong id="tests-failed">0</strong> failed</span>
              <span class="deployment-stat"><strong id="tests-duration">0</strong>s duration</span>
            </div>
          </div>
        </div>

        <details class="test-history">
          <summary>Test History</summary>
          <div id="test-history-list">
            <div class="test-history-item">
              <span class="deployment-meta">No test history available</span>
            </div>
          </div>
        </details>
      </div>
    </details>

    <!-- Service Statistics -->
    <details class="config-section" open>
      <summary>
        <span class="section-title">Service Statistics</span>
        <span class="badge badge-info" id="total-count">Loading...</span>
      </summary>
      <div class="stats-grid" id="stats-grid">
        <div class="stat-item">
          <div class="stat-value" id="stat-identities">-</div>
          <div class="stat-label">Identities</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-registries">-</div>
          <div class="stat-label">Registries</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-credentials">-</div>
          <div class="stat-label">Credentials</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-schemas">-</div>
          <div class="stat-label">Schemas</div>
        </div>
      </div>
    </details>

    <!-- Authentication Status -->
    <details class="config-section" open>
      <summary>
        <span class="section-title">Authentication</span>
        <span class="badge" id="auth-badge">Loading...</span>
      </summary>
      <div class="auth-info">
        <div class="auth-item">
          <div class="auth-value" id="auth-enabled">-</div>
          <div class="auth-label">Auth Status</div>
        </div>
        <div class="auth-item">
          <div class="auth-value" id="auth-key-count">-</div>
          <div class="auth-label">API Keys</div>
        </div>
        <div class="auth-item">
          <div class="auth-value" id="auth-version">-</div>
          <div class="auth-label">Version</div>
        </div>
        <div class="auth-item">
          <div class="auth-value" id="auth-reload-interval">-</div>
          <div class="auth-label">Reload Interval</div>
        </div>
      </div>
      <div style="padding: 0 1rem 1rem;">
        <button onclick="reloadAuth()">Reload API Keys</button>
      </div>
    </details>

    <!-- User Management -->
    <details class="config-section" open>
      <summary>
        <span class="section-title">User Management</span>
        <span class="badge badge-info" id="user-count">Loading...</span>
      </summary>
      <div style="padding: 1rem;">
        <div style="margin-bottom: 1rem;">
          <button onclick="showAddUserModal()">Add User</button>
          <button onclick="reloadUsers()">Reload Users</button>
        </div>
        <table class="data-table" id="users-table">
          <thead>
            <tr>
              <th>Email</th>
              <th>Name</th>
              <th>Roles</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="users-tbody">
            <tr><td colspan="5">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </details>

    <!-- Add/Edit User Modal -->
    <div id="user-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="user-modal-title">Add User</h3>
          <button class="modal-close" onclick="closeUserModal()">&times;</button>
        </div>
        <form id="user-form" onsubmit="submitUserForm(event)">
          <div class="form-group">
            <label for="user-email">Email</label>
            <input type="email" id="user-email" name="email" required>
          </div>
          <div class="form-group">
            <label for="user-name">Name</label>
            <input type="text" id="user-name" name="name" required>
          </div>
          <div class="form-group">
            <label for="user-password">Password</label>
            <input type="password" id="user-password" name="password">
            <small id="password-hint">Leave blank to keep existing password (edit only)</small>
          </div>
          <div class="form-group">
            <label for="user-roles">Roles</label>
            <div class="checkbox-group">
              <label><input type="checkbox" name="roles" value="issuer:admin"> Admin</label>
              <label><input type="checkbox" name="roles" value="issuer:operator"> Operator</label>
              <label><input type="checkbox" name="roles" value="issuer:readonly" checked> Read-only</label>
            </div>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="user-enabled" name="enabled" checked>
              Enabled
            </label>
          </div>
          <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="closeUserModal()">Cancel</button>
            <button type="submit" class="btn-primary" id="user-submit-btn">Add User</button>
          </div>
          <input type="hidden" id="user-edit-email" value="">
        </form>
      </div>
    </div>

    <!-- Audit Log -->
    <details class="config-section" open>
      <summary>
        <span class="section-title">Audit Log</span>
        <span class="badge badge-info" id="audit-count">Loading...</span>
      </summary>
      <div style="padding: 1rem;">
        <div class="audit-filter-bar">
          <select id="audit-action-filter" onchange="loadAuditLogs()">
            <option value="">All Actions</option>
            <option value="auth.">Authentication</option>
            <option value="identity.">Identity</option>
            <option value="credential.">Credentials</option>
            <option value="tn_mapping.">TN Mappings</option>
            <option value="organization.">Organizations</option>
            <option value="user.">Users</option>
          </select>
          <select id="audit-status-filter" onchange="loadAuditLogs()">
            <option value="">All Statuses</option>
            <option value="success">Success</option>
            <option value="denied">Denied</option>
            <option value="error">Error</option>
            <option value="revoked">Revoked</option>
          </select>
          <button onclick="loadAuditLogs()">Refresh</button>
        </div>
        <div style="overflow-x: auto;">
          <table class="audit-log-table">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Action</th>
                <th>Principal</th>
                <th>Status</th>
                <th>Resource</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody id="audit-log-body">
              <tr><td colspan="6">Loading...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="audit-buffer-info" id="audit-buffer-info"></div>
      </div>
    </details>

    <!-- Witness Configuration -->
    <details class="config-section">
      <summary>
        <span class="section-title">Witness Configuration</span>
        <span class="badge badge-info" id="witness-count">Loading...</span>
      </summary>
      <div class="config-grid">
        <div class="config-item">
          <span class="config-key">Config Path</span>
          <span class="config-value path" id="witness-config-path">Loading...</span>
        </div>
        <div class="config-item">
          <span class="config-key">Timeout</span>
          <span class="config-value" id="witness-timeout">Loading...</span>
        </div>
        <div class="config-item">
          <span class="config-key">Receipt Threshold</span>
          <span class="config-value" id="witness-threshold">Loading...</span>
        </div>
      </div>
      <div style="padding: 0 1rem;">
        <details>
          <summary>Witness URLs</summary>
          <ul class="witness-list" id="witness-urls">
            <li>Loading...</li>
          </ul>
        </details>
      </div>
      <div style="padding: 1rem;">
        <button onclick="reloadWitnesses()">Reload Witness Config</button>
      </div>
    </details>

    <!-- Persistence Configuration -->
    <details class="config-section">
      <summary>
        <span class="section-title">Persistence</span>
        <span class="badge badge-muted">Read-only</span>
      </summary>
      <div class="config-grid">
        <div class="config-item">
          <span class="config-key">Data Directory</span>
          <span class="config-value path" id="data-dir">Loading...</span>
        </div>
        <div class="config-item">
          <span class="config-key">Keystore Directory</span>
          <span class="config-value path" id="keystore-dir">Loading...</span>
        </div>
        <div class="config-item">
          <span class="config-key">Database Directory</span>
          <span class="config-value path" id="database-dir">Loading...</span>
        </div>
      </div>
    </details>

    <!-- Identity Defaults -->
    <details class="config-section">
      <summary>
        <span class="section-title">Identity Defaults</span>
        <span class="badge badge-muted">Read-only</span>
      </summary>
      <div class="config-grid">
        <div class="config-item">
          <span class="config-key">Default Key Count</span>
          <span class="config-value" id="default-key-count">Loading...</span>
        </div>
        <div class="config-item">
          <span class="config-key">Default Key Threshold</span>
          <span class="config-value" id="default-key-threshold">Loading...</span>
        </div>
        <div class="config-item">
          <span class="config-key">Default Next Key Count</span>
          <span class="config-value" id="default-next-key-count">Loading...</span>
        </div>
        <div class="config-item">
          <span class="config-key">Default Next Threshold</span>
          <span class="config-value" id="default-next-threshold">Loading...</span>
        </div>
      </div>
    </details>
  </main>

  <!-- Toast container -->
  <div id="toast-container" class="toast-container"></div>

  <script src="/static/shared.js"></script>
  <script>
    // Load deployment test results
    async function loadDeploymentTests() {
      try {
        const resp = await fetch('/admin/deployment-tests');
        if (!resp.ok) {
          if (resp.status === 401) {
            document.getElementById('deployment-badge').textContent = 'Auth Required';
            document.getElementById('deployment-badge').className = 'badge badge-warning';
            return;
          }
          throw new Error('Failed to fetch deployment tests');
        }
        const data = await resp.json();

        const badge = document.getElementById('deployment-badge');
        const statusEl = document.getElementById('deployment-status');
        const iconEl = document.getElementById('deployment-icon');
        const titleEl = document.getElementById('deployment-title');
        const metaEl = document.getElementById('deployment-meta');
        const statsEl = document.getElementById('deployment-stats');

        if (data.latest) {
          const latest = data.latest;
          const timestamp = new Date(latest.timestamp).toLocaleString();
          const shortSha = latest.git_sha.substring(0, 8);

          if (latest.passed) {
            badge.textContent = 'Passing';
            badge.className = 'badge badge-success';
            statusEl.className = 'deployment-status passed';
            iconEl.textContent = '\u2713';
            titleEl.textContent = 'Deployment Tests Passed';
          } else {
            badge.textContent = 'Failing';
            badge.className = 'badge badge-danger';
            statusEl.className = 'deployment-status failed';
            iconEl.textContent = '\u2717';
            titleEl.textContent = 'Deployment Tests Failed';
          }

          metaEl.innerHTML = `Commit <code>${shortSha}</code> tested at ${timestamp}`;
          statsEl.style.display = 'flex';
          document.getElementById('tests-passed').textContent = latest.passed_tests;
          document.getElementById('tests-failed').textContent = latest.failed_tests;
          document.getElementById('tests-duration').textContent = latest.duration_seconds.toFixed(1);
        } else {
          badge.textContent = 'No Data';
          badge.className = 'badge badge-muted';
        }

        // Render history
        const historyEl = document.getElementById('test-history-list');
        if (data.history && data.history.length > 0) {
          historyEl.innerHTML = data.history.map(item => {
            const timestamp = new Date(item.timestamp).toLocaleString();
            const shortSha = item.git_sha.substring(0, 8);
            const badgeClass = item.passed ? 'badge-success' : 'badge-danger';
            const badgeText = item.passed ? 'PASS' : 'FAIL';
            return `
              <div class="test-history-item">
                <div>
                  <span class="test-history-sha">${shortSha}</span>
                  <span class="deployment-meta">${timestamp}</span>
                </div>
                <div class="test-history-result">
                  <span>${item.passed_tests}/${item.total_tests}</span>
                  <span class="badge ${badgeClass}">${badgeText}</span>
                </div>
              </div>
            `;
          }).join('');
        }

      } catch (err) {
        console.error('Failed to load deployment tests:', err);
        document.getElementById('deployment-badge').textContent = 'Error';
        document.getElementById('deployment-badge').className = 'badge badge-danger';
      }
    }

    // Load admin data on page load
    async function loadAdminData() {
      try {
        // Fetch health
        const healthResp = await fetch('/healthz');
        const health = await healthResp.json();
        const healthEl = document.getElementById('health-status');
        if (health.ok === true) {
          healthEl.innerHTML = '<span class="status-dot healthy"></span> Healthy';
        } else {
          healthEl.innerHTML = '<span class="status-dot error"></span> Unhealthy';
        }

        // Fetch version
        const versionResp = await fetch('/version');
        const version = await versionResp.json();
        const versionEl = document.getElementById('version-value');
        if (version.github_url) {
          versionEl.innerHTML = `<a href="${version.github_url}" target="_blank" rel="noopener">${version.short_sha}</a>`;
        } else {
          versionEl.textContent = version.git_sha || 'unknown';
        }

        // Fetch admin config (may require auth)
        const configResp = await fetch('/admin/config');
        if (!configResp.ok) {
          if (configResp.status === 401) {
            showToast('Admin access requires authentication', 'warning');
            return;
          }
          throw new Error('Failed to fetch config');
        }
        const config = await configResp.json();

        // Persistence
        document.getElementById('data-dir').textContent = config.persistence.data_dir;
        document.getElementById('keystore-dir').textContent = config.persistence.keystore_dir;
        document.getElementById('database-dir').textContent = config.persistence.database_dir;

        // Witnesses
        document.getElementById('witness-config-path').textContent = config.witnesses.config_path;
        document.getElementById('witness-timeout').textContent = config.witnesses.timeout_seconds + 's';
        document.getElementById('witness-threshold').textContent = config.witnesses.receipt_threshold;
        document.getElementById('witness-count').textContent = config.witnesses.iurls.length + ' witnesses';

        const urlList = document.getElementById('witness-urls');
        if (config.witnesses.iurls.length > 0) {
          urlList.innerHTML = config.witnesses.iurls.map(url => `<li>${url}</li>`).join('');
        } else {
          urlList.innerHTML = '<li>No witnesses configured</li>';
        }

        // Identity defaults
        document.getElementById('default-key-count').textContent = config.identity_defaults.key_count;
        document.getElementById('default-key-threshold').textContent = config.identity_defaults.key_threshold;
        document.getElementById('default-next-key-count').textContent = config.identity_defaults.next_key_count;
        document.getElementById('default-next-threshold').textContent = config.identity_defaults.next_threshold;

        // Auth
        const authBadge = document.getElementById('auth-badge');
        if (config.auth.enabled) {
          authBadge.textContent = 'Enabled';
          authBadge.className = 'badge badge-success';
          document.getElementById('auth-enabled').textContent = 'ON';
        } else {
          authBadge.textContent = 'Disabled';
          authBadge.className = 'badge badge-warning';
          document.getElementById('auth-enabled').textContent = 'OFF';
        }
        document.getElementById('auth-key-count').textContent = config.auth.key_count;
        document.getElementById('auth-version').textContent = 'v' + config.auth.version;
        document.getElementById('auth-reload-interval').textContent = config.auth.reload_interval + 's';

        // Log level
        const logSelect = document.getElementById('log-level-select');
        logSelect.value = config.environment.log_level_name;

        // Fetch stats
        const statsResp = await fetch('/admin/stats');
        if (statsResp.ok) {
          const stats = await statsResp.json();
          document.getElementById('stat-identities').textContent = stats.identities;
          document.getElementById('stat-registries').textContent = stats.registries;
          document.getElementById('stat-credentials').textContent = stats.credentials;
          document.getElementById('stat-schemas').textContent = stats.schemas;

          const total = stats.identities + stats.registries + stats.credentials;
          document.getElementById('total-count').textContent = total + ' total items';
        }

      } catch (err) {
        console.error('Failed to load admin data:', err);
        showToast('Failed to load admin data: ' + err.message, 'error');
      }
    }

    async function setLogLevel() {
      const level = document.getElementById('log-level-select').value;
      try {
        const resp = await fetch('/admin/log-level', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({ level: level })
        });
        const result = await resp.json();
        if (result.success) {
          showToast('Log level set to ' + result.log_level, 'success');
        } else {
          showToast('Failed to set log level: ' + result.message, 'error');
        }
      } catch (err) {
        showToast('Failed to set log level: ' + err.message, 'error');
      }
    }

    async function reloadAuth() {
      try {
        const resp = await fetch('/admin/auth/reload', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          }
        });
        const result = await resp.json();
        if (result.success) {
          showToast('Reloaded ' + result.key_count + ' API keys', 'success');
          loadAdminData(); // Refresh
        } else {
          showToast('Failed to reload: ' + result.message, 'error');
        }
      } catch (err) {
        showToast('Failed to reload API keys: ' + err.message, 'error');
      }
    }

    async function reloadWitnesses() {
      try {
        const resp = await fetch('/admin/witnesses/reload', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          }
        });
        const result = await resp.json();
        if (result.success) {
          showToast('Reloaded ' + result.witness_count + ' witnesses', 'success');
          loadAdminData(); // Refresh
        } else {
          showToast('Failed to reload: ' + result.message, 'error');
        }
      } catch (err) {
        showToast('Failed to reload witnesses: ' + err.message, 'error');
      }
    }

    // ===== User Management Functions =====

    async function loadUsers() {
      try {
        const resp = await authFetch('/admin/users');
        if (!resp.ok) {
          if (resp.status === 401) {
            document.getElementById('user-count').textContent = 'Auth Required';
            document.getElementById('users-tbody').innerHTML = '<tr><td colspan="5">Authentication required</td></tr>';
            return;
          }
          throw new Error('Failed to fetch users');
        }
        const data = await resp.json();

        document.getElementById('user-count').textContent = data.count + ' users';

        const tbody = document.getElementById('users-tbody');
        if (data.users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5">No users configured</td></tr>';
          return;
        }

        tbody.innerHTML = data.users.map(user => {
          const rolesBadges = user.roles.map(r => {
            const roleName = r.replace('issuer:', '');
            return `<span class="badge badge-info">${roleName}</span>`;
          }).join(' ');

          const statusBadge = user.enabled
            ? '<span class="badge badge-enabled">Enabled</span>'
            : '<span class="badge badge-disabled">Disabled</span>';

          return `
            <tr>
              <td>${escapeHtml(user.email)}</td>
              <td>${escapeHtml(user.name)}</td>
              <td>${rolesBadges}</td>
              <td>${statusBadge}</td>
              <td class="actions">
                <button onclick="editUser('${escapeHtml(user.email)}')">Edit</button>
                <button class="btn-danger" onclick="deleteUser('${escapeHtml(user.email)}')">Delete</button>
              </td>
            </tr>
          `;
        }).join('');
      } catch (err) {
        console.error('Failed to load users:', err);
        document.getElementById('users-tbody').innerHTML = '<tr><td colspan="5">Failed to load users</td></tr>';
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showAddUserModal() {
      document.getElementById('user-modal-title').textContent = 'Add User';
      document.getElementById('user-submit-btn').textContent = 'Add User';
      document.getElementById('user-form').reset();
      document.getElementById('user-email').disabled = false;
      document.getElementById('user-password').required = true;
      document.getElementById('password-hint').style.display = 'none';
      document.getElementById('user-edit-email').value = '';

      // Default to readonly role
      document.querySelectorAll('#user-form input[name="roles"]').forEach(cb => {
        cb.checked = cb.value === 'issuer:readonly';
      });

      document.getElementById('user-modal').style.display = 'flex';
    }

    async function editUser(email) {
      try {
        const resp = await authFetch('/admin/users');
        if (!resp.ok) throw new Error('Failed to fetch users');
        const data = await resp.json();

        const user = data.users.find(u => u.email === email);
        if (!user) {
          showToast('User not found', 'error');
          return;
        }

        document.getElementById('user-modal-title').textContent = 'Edit User';
        document.getElementById('user-submit-btn').textContent = 'Save Changes';
        document.getElementById('user-email').value = user.email;
        document.getElementById('user-email').disabled = true;
        document.getElementById('user-name').value = user.name;
        document.getElementById('user-password').value = '';
        document.getElementById('user-password').required = false;
        document.getElementById('password-hint').style.display = 'block';
        document.getElementById('user-enabled').checked = user.enabled;
        document.getElementById('user-edit-email').value = email;

        // Set roles
        document.querySelectorAll('#user-form input[name="roles"]').forEach(cb => {
          cb.checked = user.roles.includes(cb.value);
        });

        document.getElementById('user-modal').style.display = 'flex';
      } catch (err) {
        showToast('Failed to load user: ' + err.message, 'error');
      }
    }

    function closeUserModal() {
      document.getElementById('user-modal').style.display = 'none';
    }

    async function submitUserForm(event) {
      event.preventDefault();

      const form = event.target;
      const editEmail = document.getElementById('user-edit-email').value;
      const isEdit = !!editEmail;

      const roles = Array.from(form.querySelectorAll('input[name="roles"]:checked'))
        .map(cb => cb.value);

      const data = {
        name: form.name.value,
        roles: roles,
        enabled: form.enabled.checked,
      };

      if (!isEdit) {
        data.email = form.email.value;
        data.password = form.password.value;
      } else if (form.password.value) {
        data.password = form.password.value;
      }

      try {
        const url = isEdit ? `/admin/users/${encodeURIComponent(editEmail)}` : '/admin/users';
        const method = isEdit ? 'PATCH' : 'POST';

        const resp = await authFetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (!resp.ok) {
          const error = await resp.json();
          throw new Error(error.detail || 'Failed to save user');
        }

        showToast(isEdit ? 'User updated successfully' : 'User created successfully', 'success');
        closeUserModal();
        loadUsers();
      } catch (err) {
        showToast('Failed to save user: ' + err.message, 'error');
      }
    }

    async function deleteUser(email) {
      if (!confirm(`Are you sure you want to delete user "${email}"?`)) {
        return;
      }

      try {
        const resp = await authFetch(`/admin/users/${encodeURIComponent(email)}`, {
          method: 'DELETE',
        });

        if (!resp.ok) {
          const error = await resp.json();
          throw new Error(error.detail || 'Failed to delete user');
        }

        const result = await resp.json();
        showToast(`User deleted. ${result.sessions_invalidated} sessions invalidated.`, 'success');
        loadUsers();
      } catch (err) {
        showToast('Failed to delete user: ' + err.message, 'error');
      }
    }

    async function reloadUsers() {
      try {
        const resp = await authFetch('/admin/users/reload', {
          method: 'POST',
        });
        const result = await resp.json();
        if (result.success) {
          showToast('Reloaded ' + result.user_count + ' users', 'success');
          loadUsers();
        } else {
          showToast('Failed to reload: ' + result.message, 'error');
        }
      } catch (err) {
        showToast('Failed to reload users: ' + err.message, 'error');
      }
    }

    // Audit Log functions
    async function loadAuditLogs() {
      const tbody = document.getElementById('audit-log-body');
      const countBadge = document.getElementById('audit-count');
      const bufferInfo = document.getElementById('audit-buffer-info');

      const actionFilter = document.getElementById('audit-action-filter').value;
      const statusFilter = document.getElementById('audit-status-filter').value;

      try {
        let url = '/admin/audit-logs?limit=100';
        if (actionFilter) url += '&action=' + encodeURIComponent(actionFilter);
        if (statusFilter) url += '&status=' + encodeURIComponent(statusFilter);

        const resp = await authFetch(url);
        if (!resp.ok) {
          if (resp.status === 401) {
            tbody.innerHTML = '<tr><td colspan="6">Authentication required</td></tr>';
            countBadge.textContent = 'Auth Required';
            countBadge.className = 'badge badge-warning';
            return;
          }
          throw new Error('Failed to fetch audit logs');
        }

        const data = await resp.json();
        countBadge.textContent = data.count + ' events';
        countBadge.className = 'badge badge-info';
        bufferInfo.textContent = `Buffer: ${data.buffer_size} / ${data.max_buffer_size} events`;

        if (data.events.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6">No audit events found</td></tr>';
          return;
        }

        tbody.innerHTML = data.events.map(event => {
          const timestamp = new Date(event.timestamp).toLocaleString();
          const statusClass = 'status-' + (event.status || 'success');
          const details = event.details ? JSON.stringify(event.details) : '-';
          return `
            <tr>
              <td class="timestamp">${escapeHtmlSimple(timestamp)}</td>
              <td class="action">${escapeHtmlSimple(event.action)}</td>
              <td>${escapeHtmlSimple(event.principal || 'anonymous')}</td>
              <td class="${statusClass}">${escapeHtmlSimple(event.status || 'success')}</td>
              <td>${escapeHtmlSimple(event.resource || '-')}</td>
              <td class="details" title="${escapeHtmlSimple(details)}">${escapeHtmlSimple(details)}</td>
            </tr>
          `;
        }).join('');

      } catch (err) {
        console.error('Failed to load audit logs:', err);
        tbody.innerHTML = '<tr><td colspan="6">Error: ' + escapeHtmlSimple(err.message) + '</td></tr>';
        countBadge.textContent = 'Error';
        countBadge.className = 'badge badge-danger';
      }
    }

    function escapeHtmlSimple(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadAdminData();
      loadDeploymentTests();
      loadUsers();
      loadAuditLogs();
    });
  </script>
</body>
</html>
