<?xml version="1.0" encoding="utf-8"?>
<!--
  VVP Dialplan - Handles inbound PSTN, outbound, and internal extension calls

  This dialplan:
  1. Routes internal extension calls (1001, 1006, etc.) directly
  2. Routes UK outbound calls (9+0+number) to Twilio with valid caller ID
  3. Routes international calls (9+00+country+number) to Twilio
  4. Handles inbound PSTN calls with VVP header injection
  5. Maps +441923311006 → extension 1006

  Extensions:
  - 1001: Primary test extension (password: vvptest1001)
  - 1006: Secondary test extension for +441923311006 (password: vvptest1006)

  File: /etc/freeswitch/dialplan/public.xml

  After updating, reload dialplan:
    fs_cli -x "reloadxml"
-->
<include>
  <context name="public">

    <!-- Internal extension dialing (1001-1099) - direct, no VVP -->
    <extension name="internal-extensions">
      <condition field="${sofia_profile_name}" expression="^internal$"/>
      <condition field="destination_number" expression="^(10\d{2})$">
        <action application="log" data="INFO [VVP] Internal call to extension $1"/>
        <action application="set" data="hangup_after_bridge=true"/>
        <action application="bridge" data="user/$1@pbx.rcnx.io"/>
      </condition>
    </extension>

    <!-- VVP Loopback Test: 7 + extension -> signing -> verification -> extension -->
    <!-- Dial 71006 to call 1006 through full VVP signing/verification flow -->
    <extension name="vvp-loopback-outbound">
      <!-- Match internal SIP profile OR loopback channels (empty profile name for fs_cli originate) -->
      <condition field="${sofia_profile_name}" expression="^(internal)?$"/>
      <condition field="destination_number" expression="^7(10\d{2})$">
        <action application="log" data="INFO [VVP] Loopback call to extension $1 via VVP signing"/>
        <action application="set" data="hangup_after_bridge=true"/>
        <action application="set" data="continue_on_fail=true"/>
        <!-- Allow 30s for signing service (TN lookup + VVP create can take 5-15s) -->
        <action application="set" data="bridge_timeout=30"/>
        <action application="set" data="progress_timeout=30"/>
        <!-- SIP Timer B: max wait for INVITE transaction (default 32s, extend to 35s) -->
        <action application="set" data="sip_invite_timeout=35"/>
        <!-- Map extension to test TN: dest from dialed digits, caller is +441923311000 -->
        <action application="set" data="loopback_dest_tn=+44192331$1"/>
        <action application="set" data="effective_caller_id_number=+441923311000"/>
        <action application="set" data="effective_caller_id_name=VVP Loopback"/>
        <!-- Route signing 302 through redirected context (not directly to Contact URI) -->
        <action application="set" data="sip_redirect_context=redirected"/>
        <!-- Route through signing service with org API key -->
        <action application="export" data="nolocal:sip_h_X-VVP-API-Key=9pEqpjllD7rkNQQYYKR2x182d6WmkNL4QCHoxj9_r9o"/>
        <action application="log" data="INFO [VVP] Routing to signing service: ${loopback_dest_tn}"/>
        <action application="bridge" data="sofia/external/${loopback_dest_tn}@127.0.0.1:5070"/>
      </condition>
    </extension>

    <!-- VVP Loopback Inbound: calls from verification service with VVP headers -->
    <extension name="vvp-loopback-inbound">
      <condition field="${sofia_profile_name}" expression="^external$"/>
      <condition field="destination_number" expression="^\+?4419233110(\d{2})$">
        <action application="log" data="INFO [VVP] Loopback inbound for extension 10$1"/>
        <!-- Extract VVP headers from 302 response (sip_rh_*) or INVITE (sip_h_*) -->
        <action application="set" data="vvp_brand_name=${sip_rh_X-VVP-Brand-Name}"/>
        <action application="set" data="vvp_brand_logo=${sip_rh_X-VVP-Brand-Logo}"/>
        <action application="set" data="vvp_status=${sip_rh_X-VVP-Status}"/>
        <!-- Fallback to request headers if response headers not available -->
        <action application="set" data="vvp_brand_name=${vvp_brand_name:${sip_h_X-VVP-Brand-Name}}"/>
        <action application="set" data="vvp_brand_logo=${vvp_brand_logo:${sip_h_X-VVP-Brand-Logo}}"/>
        <action application="set" data="vvp_status=${vvp_status:${sip_h_X-VVP-Status}}"/>
        <!-- URL decode -->
        <action application="set" data="vvp_brand_name=${url_decode(${vvp_brand_name})}"/>
        <action application="set" data="vvp_brand_logo=${url_decode(${vvp_brand_logo})}"/>
        <action application="log" data="INFO [VVP] Loopback: brand=${vvp_brand_name}, status=${vvp_status}"/>
        <!-- Export to B-leg for WebRTC client -->
        <action application="export" data="nolocal:sip_h_X-VVP-Brand-Name=${vvp_brand_name}"/>
        <action application="export" data="nolocal:sip_h_X-VVP-Brand-Logo=${vvp_brand_logo}"/>
        <action application="export" data="nolocal:sip_h_X-VVP-Status=${vvp_status}"/>
        <action application="ring_ready"/>
        <action application="set" data="hangup_after_bridge=true"/>
        <!-- Bridge to destination extension -->
        <action application="set" data="target_ext=10$1"/>
        <action application="bridge" data="user/${target_ext}@pbx.rcnx.io"/>
      </condition>
    </extension>

    <!-- UK Outbound: 9 + 0 + UK number -> Twilio gateway -->
    <extension name="uk-outbound-9prefix">
      <condition field="${sofia_profile_name}" expression="^internal$"/>
      <condition field="destination_number" expression="^90(\d{9,11})$">
        <action application="log" data="INFO [VVP] UK Outbound: dialing +44$1 via Twilio"/>
        <action application="export" data="call_direction=outbound"/>
        <action application="set" data="hangup_after_bridge=true"/>
        <action application="set" data="continue_on_fail=true"/>
        <!-- Set valid caller ID for Twilio -->
        <action application="set" data="effective_caller_id_number=+441923311000"/>
        <action application="set" data="effective_caller_id_name=VVP Test"/>
        <action application="bridge" data="sofia/gateway/7d3b7bf4-e1e7-43f0-8d6c-5dd4eb6e35cc/+44$1"/>
      </condition>
    </extension>

    <!-- International Outbound: 9 + 00 + country code + number -->
    <extension name="intl-outbound-9prefix">
      <condition field="${sofia_profile_name}" expression="^internal$"/>
      <condition field="destination_number" expression="^900(\d{10,15})$">
        <action application="log" data="INFO [VVP] Intl Outbound: dialing +$1 via Twilio"/>
        <action application="export" data="call_direction=outbound"/>
        <action application="set" data="hangup_after_bridge=true"/>
        <action application="set" data="continue_on_fail=true"/>
        <!-- Set valid caller ID for Twilio -->
        <action application="set" data="effective_caller_id_number=+441923311000"/>
        <action application="set" data="effective_caller_id_name=VVP Test"/>
        <action application="bridge" data="sofia/gateway/7d3b7bf4-e1e7-43f0-8d6c-5dd4eb6e35cc/+$1"/>
      </condition>
    </extension>

    <!-- VVP Inbound to +441923311006 -> extension 1006 -->
    <extension name="vvp-inbound-1006">
      <condition field="${sofia_profile_name}" expression="^external$"/>
      <condition field="destination_number" expression="^\+?441923311006$">
        <action application="log" data="INFO [VVP] Inbound PSTN call to 1006 from ${caller_id_number}"/>
        <action application="set" data="vvp_brand_name=Test Corporation Ltd"/>
        <action application="set" data="vvp_brand_logo=https://example.com/logo.png"/>
        <action application="set" data="vvp_status=VALID"/>
        <action application="set" data="sip_h_X-VVP-Brand-Name=${vvp_brand_name}"/>
        <action application="set" data="sip_h_X-VVP-Brand-Logo=${vvp_brand_logo}"/>
        <action application="set" data="sip_h_X-VVP-Status=${vvp_status}"/>
        <action application="export" data="nolocal:sip_h_X-VVP-Brand-Name=${vvp_brand_name}"/>
        <action application="export" data="nolocal:sip_h_X-VVP-Brand-Logo=${vvp_brand_logo}"/>
        <action application="export" data="nolocal:sip_h_X-VVP-Status=${vvp_status}"/>
        <action application="ring_ready"/>
        <action application="set" data="hangup_after_bridge=true"/>
        <action application="set" data="continue_on_fail=true"/>
        <action application="bridge" data="user/1006@pbx.rcnx.io"/>
        <action application="log" data="WARNING [VVP] Bridge to 1006 failed"/>
        <action application="answer"/>
        <action application="playback" data="ivr/ivr-call_cannot_be_completed_as_dialed.wav"/>
        <action application="hangup" data="USER_BUSY"/>
      </condition>
    </extension>

    <!-- VVP Inbound to +441923311000 -> extension 1001 (default) -->
    <extension name="vvp-inbound-1001">
      <condition field="${sofia_profile_name}" expression="^external$">
        <action application="log" data="INFO [VVP] Inbound PSTN call to 1001 from ${caller_id_number}"/>
        <action application="set" data="vvp_brand_name=Test Corporation Ltd"/>
        <action application="set" data="vvp_brand_logo=https://example.com/logo.png"/>
        <action application="set" data="vvp_status=VALID"/>
        <action application="set" data="sip_h_X-VVP-Brand-Name=${vvp_brand_name}"/>
        <action application="set" data="sip_h_X-VVP-Brand-Logo=${vvp_brand_logo}"/>
        <action application="set" data="sip_h_X-VVP-Status=${vvp_status}"/>
        <action application="export" data="nolocal:sip_h_X-VVP-Brand-Name=${vvp_brand_name}"/>
        <action application="export" data="nolocal:sip_h_X-VVP-Brand-Logo=${vvp_brand_logo}"/>
        <action application="export" data="nolocal:sip_h_X-VVP-Status=${vvp_status}"/>
        <action application="ring_ready"/>
        <action application="set" data="hangup_after_bridge=true"/>
        <action application="set" data="continue_on_fail=true"/>
        <action application="bridge" data="user/1001@pbx.rcnx.io"/>
        <action application="log" data="WARNING [VVP] Bridge to 1001 failed"/>
        <action application="answer"/>
        <action application="playback" data="ivr/ivr-call_cannot_be_completed_as_dialed.wav"/>
        <action application="hangup" data="USER_BUSY"/>
      </condition>
    </extension>

    <!-- Fallback for unmatched internal calls -->
    <extension name="internal-unmatched">
      <condition field="${sofia_profile_name}" expression="^internal$">
        <action application="log" data="WARNING [VVP] Unmatched internal call to ${destination_number}"/>
        <action application="playback" data="ivr/ivr-call_cannot_be_completed_as_dialed.wav"/>
        <action application="hangup" data="NO_ROUTE_DESTINATION"/>
      </condition>
    </extension>

  </context>

  <!-- Redirected context: handles calls after 302 redirect from signing service -->
  <!-- Sprint 48: Routes through verification service (5071) before delivering to extension -->
  <context name="redirected">

    <!-- VVP Redirect: signing 302 -> verification service -> extension -->
    <extension name="vvp-redirect-to-verify">
      <condition field="destination_number" expression="^\+?44192331(\d{4})$">
        <action application="log" data="INFO [VVP] Signing 302 redirect for +44192331$1 — routing to verification"/>
        <!-- Extract STIR attestation headers from signing 302 response (stored as sip_rh_*) -->
        <!-- Sprint 60: Only attestation headers forwarded. No X-VVP-* brand headers — -->
        <!-- brand/status are derived by verification service from dossier evidence. -->
        <action application="set" data="vvp_identity_hdr=${sip_rh_Identity}"/>
        <action application="set" data="vvp_identity=${sip_rh_P-VVP-Identity}"/>
        <action application="set" data="vvp_passport=${sip_rh_P-VVP-Passport}"/>
        <action application="log" data="INFO [VVP] Signing result: Identity=${vvp_identity_hdr:+yes:no}, Passport=${vvp_passport:+yes:no}"/>
        <!-- Forward STIR attestation headers to verification service -->
        <action application="export" data="nolocal:sip_h_Identity=${vvp_identity_hdr}"/>
        <action application="export" data="nolocal:sip_h_P-VVP-Identity=${vvp_identity}"/>
        <action application="export" data="nolocal:sip_h_P-VVP-Passport=${vvp_passport}"/>
        <!-- When verification returns 302, route to verified context for delivery -->
        <!-- Use export (not set) so the B-leg inherits the updated redirect context -->
        <action application="export" data="sip_redirect_context=verified"/>
        <action application="set" data="hangup_after_bridge=true"/>
        <action application="set" data="continue_on_fail=true"/>
        <action application="set" data="bridge_timeout=30"/>
        <action application="set" data="sip_invite_timeout=35"/>
        <action application="log" data="INFO [VVP] Bridging to verification service at 127.0.0.1:5071"/>
        <action application="bridge" data="sofia/external/${destination_number}@127.0.0.1:5071"/>
      </condition>
    </extension>

    <!-- Fallback for unmatched redirects -->
    <extension name="redirect-unmatched">
      <condition field="destination_number" expression=".*">
        <action application="log" data="WARNING [VVP] Unmatched redirect to ${destination_number}"/>
        <action application="hangup" data="NO_ROUTE_DESTINATION"/>
      </condition>
    </extension>

  </context>

  <!-- Verified context: delivers call to extension after verification 302 -->
  <!-- Sprint 48: Third stage of VVP call flow — signing → verification → delivery -->
  <context name="verified">

    <!-- Deliver verified call to destination extension -->
    <extension name="vvp-deliver">
      <condition field="destination_number" expression="^\+?4419233110(\d{2})$">
        <action application="log" data="INFO [VVP] Verification complete — delivering to extension 10$1"/>
        <!-- Extract VVP headers from verification 302 response -->
        <action application="set" data="vvp_brand_name=${sip_rh_X-VVP-Brand-Name}"/>
        <action application="set" data="vvp_brand_logo=${sip_rh_X-VVP-Brand-Logo}"/>
        <action application="set" data="vvp_status=${sip_rh_X-VVP-Status}"/>
        <!-- Fallback to request headers -->
        <action application="set" data="vvp_brand_name=${vvp_brand_name:${sip_h_X-VVP-Brand-Name}}"/>
        <action application="set" data="vvp_brand_logo=${vvp_brand_logo:${sip_h_X-VVP-Brand-Logo}}"/>
        <action application="set" data="vvp_status=${vvp_status:${sip_h_X-VVP-Status}}"/>
        <!-- URL decode -->
        <action application="set" data="vvp_brand_name=${url_decode(${vvp_brand_name})}"/>
        <action application="set" data="vvp_brand_logo=${url_decode(${vvp_brand_logo})}"/>
        <action application="log" data="INFO [VVP] Delivering: brand=${vvp_brand_name}, status=${vvp_status}"/>
        <!-- Export VVP headers to B-leg for WebRTC client -->
        <action application="export" data="nolocal:sip_h_X-VVP-Brand-Name=${vvp_brand_name}"/>
        <action application="export" data="nolocal:sip_h_X-VVP-Brand-Logo=${vvp_brand_logo}"/>
        <action application="export" data="nolocal:sip_h_X-VVP-Status=${vvp_status}"/>
        <action application="ring_ready"/>
        <action application="set" data="hangup_after_bridge=true"/>
        <action application="set" data="target_ext=10$1"/>
        <action application="bridge" data="user/${target_ext}@pbx.rcnx.io"/>
      </condition>
    </extension>

    <!-- Fallback for unmatched verified calls -->
    <extension name="verified-unmatched">
      <condition field="destination_number" expression=".*">
        <action application="log" data="WARNING [VVP] Unmatched verified call to ${destination_number}"/>
        <action application="hangup" data="NO_ROUTE_DESTINATION"/>
      </condition>
    </extension>

  </context>
</include>
