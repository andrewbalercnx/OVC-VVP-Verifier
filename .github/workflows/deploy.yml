name: Build and deploy to Azure Container Apps

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  id-token: write   # required for OIDC to Azure

jobs:
  # =========================================================================
  # TEST JOBS - Run tests for both services
  # =========================================================================
  test-verifier:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/verifier

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install libsodium
        working-directory: .
        run: |
          sudo apt-get update
          sudo apt-get install -y libsodium-dev
          ldconfig -p | grep libsodium || echo "libsodium found in apt paths"

      - name: Install common package
        working-directory: common
        run: pip install -e .

      - name: Install dependencies
        run: |
          pip install -e .
          pip install pytest pytest-asyncio pytest-cov

      - name: Verify pysodium import
        run: python3 -c "import pysodium; print('pysodium OK')"

      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=app --cov-report=xml --cov-fail-under=79

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: services/verifier/coverage.xml
        continue-on-error: true

  test-issuer:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/issuer

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install libsodium
        working-directory: .
        run: |
          sudo apt-get update
          sudo apt-get install -y libsodium-dev
          ldconfig -p | grep libsodium || echo "libsodium found in apt paths"

      - name: Install keripy
        run: pip install keri>=1.2.0

      - name: Install common package
        working-directory: common
        run: pip install -e .

      - name: Install dependencies
        run: |
          pip install -e .
          pip install pytest pytest-asyncio pytest-cov

      - name: Verify pysodium import
        run: python3 -c "import pysodium; print('pysodium OK')"

      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=app --cov-report=xml --cov-fail-under=60

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: services/issuer/coverage.xml
        continue-on-error: true

  # =========================================================================
  # DEPLOY VERIFIER
  # =========================================================================
  deploy-verifier:
    needs: [test-verifier, test-issuer, verify-witnesses]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: |
          az acr login -n "${{ secrets.ACR_NAME }}"

      - name: Build and push verifier image
        run: |
          IMAGE="${{ secrets.ACR_LOGIN_SERVER }}/vvp-verifier:${{ github.sha }}"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          docker build -t "$IMAGE" -f services/verifier/Dockerfile .
          docker push "$IMAGE"

      - name: Deploy verifier
        run: |
          az containerapp update \
            --resource-group "${{ secrets.AZURE_RG }}" \
            --name "${{ secrets.AZURE_CONTAINERAPP_NAME }}" \
            --image "$IMAGE" \
            --min-replicas 1 \
            --set-env-vars "GIT_SHA=${{ github.sha }}" "GITHUB_REPOSITORY=${{ github.repository }}"

  # =========================================================================
  # DEPLOY ISSUER
  # =========================================================================
  deploy-issuer:
    needs: [test-verifier, test-issuer, verify-witnesses]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: |
          az acr login -n "${{ secrets.ACR_NAME }}"

      - name: Build and push issuer image
        run: |
          IMAGE="${{ secrets.ACR_LOGIN_SERVER }}/vvp-issuer:${{ github.sha }}"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          docker build -t "$IMAGE" -f services/issuer/Dockerfile .
          docker push "$IMAGE"

      - name: Deploy issuer
        run: |
          az containerapp update \
            --resource-group "${{ secrets.AZURE_RG }}" \
            --name "vvp-issuer" \
            --image "$IMAGE" \
            --min-replicas 1 \
            --set-env-vars "GIT_SHA=${{ github.sha }}" "GITHUB_REPOSITORY=${{ github.repository }}"

  # =========================================================================
  # BUILD WITNESS IMAGE
  # =========================================================================
  # Build the custom witness image once, then deploy to all witnesses
  build-witness-image:
    needs: [test-verifier, test-issuer]
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.build.outputs.image }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: |
          az acr login -n "${{ secrets.ACR_NAME }}"

      - name: Build and push witness image
        id: build
        run: |
          IMAGE="${{ secrets.ACR_LOGIN_SERVER }}/vvp-witness:${{ github.sha }}"
          echo "Building witness image: $IMAGE"
          docker build -t "$IMAGE" -f services/witness/Dockerfile .
          docker push "$IMAGE"
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

  # =========================================================================
  # DEPLOY WITNESSES
  # =========================================================================
  # Deploy the custom witness image to each witness container app
  deploy-witnesses:
    needs: [build-witness-image]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        witness:
          - name: vvp-witness1
            witness_name: wan
            http_port: 5642
            tcp_port: 5632
          - name: vvp-witness2
            witness_name: wil
            http_port: 5643
            tcp_port: 5633
          - name: vvp-witness3
            witness_name: wes
            http_port: 5644
            tcp_port: 5634

    env:
      WITNESS_IMAGE: ${{ needs.build-witness-image.outputs.image }}

    steps:
      - name: Validate image output
        run: |
          if [ -z "$WITNESS_IMAGE" ]; then
            echo "WARNING: Witness image output is empty, constructing from secrets"
            # Fallback: construct image URL directly
            WITNESS_IMAGE="${{ secrets.ACR_LOGIN_SERVER }}/vvp-witness:${{ github.sha }}"
            echo "WITNESS_IMAGE=$WITNESS_IMAGE" >> $GITHUB_ENV
          fi
          echo "Using witness image: $WITNESS_IMAGE"

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy witness
        run: |
          echo "Deploying ${{ matrix.witness.name }} with image: $WITNESS_IMAGE"

          # Update the container app with the new image and environment variables
          az containerapp update \
            --name ${{ matrix.witness.name }} \
            --resource-group ${{ secrets.AZURE_RG }} \
            --image "$WITNESS_IMAGE" \
            --set-env-vars \
              "WITNESS_NAME=${{ matrix.witness.witness_name }}" \
              "HTTP_PORT=${{ matrix.witness.http_port }}" \
              "TCP_PORT=${{ matrix.witness.tcp_port }}" \
              "GIT_SHA=${{ github.sha }}"

      - name: Wait for witness to be ready
        run: |
          echo "Waiting for witness ${{ matrix.witness.name }} to be ready..."
          for i in {1..30}; do
            STATUS=$(az containerapp show \
              --name ${{ matrix.witness.name }} \
              --resource-group ${{ secrets.AZURE_RG }} \
              --query "properties.runningStatus" -o tsv)
            if [ "$STATUS" = "Running" ]; then
              echo "Witness is running"
              break
            fi
            echo "Attempt $i/30: Status is $STATUS, waiting..."
            sleep 10
          done

  # =========================================================================
  # VERIFY WITNESSES
  # =========================================================================
  verify-witnesses:
    needs: [deploy-witnesses]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        witness:
          - name: vvp-witness1
            aid: BBilc4-L3tFUnfM_wJr4S4OJanAv_VmF_dJNN6vkf2Ha
          - name: vvp-witness2
            aid: BLskRTInXnMxWaGqcpSyMgo0nYbalW99cGZESrz3zapM
          - name: vvp-witness3
            aid: BIKKuvBwpmDVA4Ds-EpL5bt9OqPzWPja2LigFYZN2YfX

    steps:
      - name: Verify witness OOBI endpoint
        run: |
          WITNESS_URL="https://${{ matrix.witness.name }}.rcnx.io"
          OOBI_URL="${WITNESS_URL}/oobi/${{ matrix.witness.aid }}/controller"
          echo "Checking OOBI endpoint: $OOBI_URL"

          # Retry a few times in case witness is still warming up
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$OOBI_URL" || echo "000")
            echo "Attempt $i: HTTP response code: $HTTP_CODE"
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "202" ]; then
              echo "Witness OOBI endpoint is healthy"
              exit 0
            fi
            sleep 10
          done

          echo "::warning::Witness OOBI endpoint returned $HTTP_CODE after 5 attempts"

  # =========================================================================
  # POST-DEPLOYMENT INTEGRATION TESTS
  # =========================================================================
  # Run full E2E integration tests after deployment to verify the system works
  post-deployment-tests:
    needs: [deploy-verifier, deploy-issuer, verify-witnesses]
    runs-on: ubuntu-latest

    env:
      VVP_ISSUER_URL: https://vvp-issuer.rcnx.io
      VVP_VERIFIER_URL: https://vvp-verifier.rcnx.io
      VVP_TEST_MODE: azure

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install libsodium
        run: |
          sudo apt-get update
          sudo apt-get install -y libsodium-dev

      - name: Install keripy
        run: pip install keri>=1.2.0

      - name: Install common package
        working-directory: common
        run: pip install -e .

      - name: Install test dependencies
        run: |
          pip install pytest pytest-asyncio aiohttp httpx pysodium azure-storage-blob

      - name: Wait for services to be ready
        run: |
          echo "Waiting for issuer and verifier to be ready..."
          for i in {1..30}; do
            ISSUER_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$VVP_ISSUER_URL/healthz" || echo "000")
            VERIFIER_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$VVP_VERIFIER_URL/healthz" || echo "000")
            echo "Attempt $i/30: Issuer=$ISSUER_STATUS, Verifier=$VERIFIER_STATUS"
            if [ "$ISSUER_STATUS" = "200" ] && [ "$VERIFIER_STATUS" = "200" ]; then
              echo "Both services are ready"
              break
            fi
            sleep 10
          done

      - name: Run integration tests
        id: integration_tests
        env:
          VVP_TEST_API_KEY: ${{ secrets.VVP_ADMIN_API_KEY }}
          VVP_AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
        run: |
          START_TIME=$(date +%s)
          set +e

          # Run a subset of integration tests (skip benchmarks for speed)
          python -m pytest tests/integration/ \
            -v \
            --tb=short \
            -m "integration and not benchmark" \
            --ignore=tests/integration/benchmarks/ \
            2>&1 | tee test_output.txt

          TEST_EXIT_CODE=$?
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          # Parse test results
          PASSED=$(grep -oP '\d+(?= passed)' test_output.txt | tail -1 || echo "0")
          FAILED=$(grep -oP '\d+(?= failed)' test_output.txt | tail -1 || echo "0")
          TOTAL=$((PASSED + FAILED))

          # Set outputs
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT

          # Capture errors for reporting
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            grep -A 5 "FAILED\|ERROR" test_output.txt > errors.txt || true
          fi

          exit $TEST_EXIT_CODE

      - name: Submit test results to admin endpoint
        if: always()
        env:
          VVP_TEST_API_KEY: ${{ secrets.VVP_ADMIN_API_KEY }}
        run: |
          # Determine pass/fail status
          if [ "${{ steps.integration_tests.outputs.exit_code }}" = "0" ]; then
            PASSED_STATUS=true
          else
            PASSED_STATUS=false
          fi

          # Collect errors if any
          ERRORS="[]"
          if [ -f errors.txt ]; then
            ERRORS=$(cat errors.txt | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi

          # Submit results
          curl -X POST "${VVP_ISSUER_URL}/admin/deployment-tests" \
            -H "Authorization: Bearer ${VVP_TEST_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "git_sha": "${{ github.sha }}",
            "passed": ${PASSED_STATUS},
            "total_tests": ${{ steps.integration_tests.outputs.total || 0 }},
            "passed_tests": ${{ steps.integration_tests.outputs.passed || 0 }},
            "failed_tests": ${{ steps.integration_tests.outputs.failed || 0 }},
            "duration_seconds": ${{ steps.integration_tests.outputs.duration || 0 }},
            "issuer_url": "${VVP_ISSUER_URL}",
            "verifier_url": "${VVP_VERIFIER_URL}",
            "errors": ${ERRORS}
          }
          EOF

          echo "Test results submitted to ${VVP_ISSUER_URL}/admin/deployment-tests"

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            test_output.txt
            errors.txt
          retention-days: 7
