name: Build and deploy to Azure Container Apps

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  id-token: write   # required for OIDC to Azure

jobs:
  # =========================================================================
  # DETECT CHANGED PATHS
  # =========================================================================
  # Determine which services have changed to skip unnecessary builds
  changes:
    runs-on: ubuntu-latest
    outputs:
      witness: ${{ steps.filter.outputs.witness }}
      issuer: ${{ steps.filter.outputs.issuer }}
      verifier: ${{ steps.filter.outputs.verifier }}
      sip-redirect: ${{ steps.filter.outputs.sip-redirect }}
      sip-verify: ${{ steps.filter.outputs.sip-verify }}
      pbx-config: ${{ steps.filter.outputs.pbx-config }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            witness:
              - 'services/witness/**'
            issuer:
              - 'services/issuer/**'
              - 'common/**'
            verifier:
              - 'services/verifier/**'
              - 'common/**'
            sip-redirect:
              - 'services/sip-redirect/**'
              - 'common/**'
            sip-verify:
              - 'services/sip-verify/**'
              - 'common/**'
            pbx-config:
              - 'services/pbx/config/**'

  # =========================================================================
  # TEST JOBS - Run tests for both services
  # =========================================================================
  test-verifier:
    needs: [changes]
    if: needs.changes.outputs.verifier == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/verifier

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install libsodium
        working-directory: .
        run: |
          sudo apt-get update
          sudo apt-get install -y libsodium-dev
          ldconfig -p | grep libsodium || echo "libsodium found in apt paths"

      - name: Install common package
        working-directory: common
        run: pip install -e .

      - name: Install dependencies
        run: |
          pip install -e .
          pip install pytest pytest-asyncio pytest-cov

      - name: Verify pysodium import
        run: python3 -c "import pysodium; print('pysodium OK')"

      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=app --cov-report=xml --cov-fail-under=79

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: services/verifier/coverage.xml
        continue-on-error: true

  test-issuer:
    needs: [changes]
    if: needs.changes.outputs.issuer == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/issuer

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install libsodium
        working-directory: .
        run: |
          sudo apt-get update
          sudo apt-get install -y libsodium-dev
          ldconfig -p | grep libsodium || echo "libsodium found in apt paths"

      - name: Install keripy
        run: pip install keri>=1.2.0

      - name: Install common package
        working-directory: common
        run: pip install -e .

      - name: Install dependencies
        run: |
          pip install -e .
          pip install pytest pytest-asyncio pytest-cov

      - name: Verify pysodium import
        run: python3 -c "import pysodium; print('pysodium OK')"

      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=app --cov-report=xml --cov-fail-under=60

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: services/issuer/coverage.xml
        continue-on-error: true

  # =========================================================================
  # TEST SIP REDIRECT SERVICE
  # =========================================================================
  # Only runs when sip-redirect code changes
  test-sip-redirect:
    needs: [changes]
    if: needs.changes.outputs.sip-redirect == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/sip-redirect

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install libsodium
        working-directory: .
        run: |
          sudo apt-get update
          sudo apt-get install -y libsodium-dev

      - name: Install common package
        working-directory: common
        run: pip install -e .

      - name: Install dependencies
        run: |
          pip install -e .
          pip install pytest pytest-asyncio

      - name: Run tests
        run: |
          pytest tests/ -v

  # =========================================================================
  # TEST SIP VERIFY SERVICE
  # =========================================================================
  # Only runs when sip-verify code changes
  test-sip-verify:
    needs: [changes]
    if: needs.changes.outputs.sip-verify == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/sip-verify

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install libsodium
        working-directory: .
        run: |
          sudo apt-get update
          sudo apt-get install -y libsodium-dev

      - name: Install common package
        working-directory: common
        run: pip install -e .

      - name: Install dependencies
        run: |
          pip install -e .
          pip install pytest pytest-asyncio aiohttp

      - name: Run tests
        run: |
          pytest tests/ -v

  # =========================================================================
  # DEPLOY VERIFIER
  # =========================================================================
  deploy-verifier:
    needs: [changes, test-verifier]
    if: needs.changes.outputs.verifier == 'true' && !failure()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: |
          az acr login -n "${{ secrets.ACR_NAME }}"

      - name: Build and push verifier image
        run: |
          IMAGE="${{ secrets.ACR_LOGIN_SERVER }}/vvp-verifier:${{ github.sha }}"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          docker build -t "$IMAGE" -f services/verifier/Dockerfile .
          docker push "$IMAGE"

      - name: Deploy verifier
        run: |
          az containerapp update \
            --resource-group "${{ secrets.AZURE_RG }}" \
            --name "${{ secrets.AZURE_CONTAINERAPP_NAME }}" \
            --image "$IMAGE" \
            --min-replicas 1 \
            --set-env-vars \
              "GIT_SHA=${{ github.sha }}" \
              "GITHUB_REPOSITORY=${{ github.repository }}" \
              "VVP_LOCAL_WITNESS_URLS=https://vvp-witness1.rcnx.io,https://vvp-witness2.rcnx.io,https://vvp-witness3.rcnx.io"

  # =========================================================================
  # DEPLOY ISSUER
  # =========================================================================
  deploy-issuer:
    needs: [changes, test-issuer]
    if: needs.changes.outputs.issuer == 'true' && !failure()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: |
          az acr login -n "${{ secrets.ACR_NAME }}"

      - name: Build and push issuer image
        run: |
          IMAGE="${{ secrets.ACR_LOGIN_SERVER }}/vvp-issuer:${{ github.sha }}"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          docker build -t "$IMAGE" -f services/issuer/Dockerfile .
          docker push "$IMAGE"

      - name: Deploy issuer
        run: |
          az containerapp update \
            --resource-group "${{ secrets.AZURE_RG }}" \
            --name "vvp-issuer" \
            --image "$IMAGE" \
            --min-replicas 1 \
            --set-env-vars \
              "GIT_SHA=${{ github.sha }}" \
              "GITHUB_REPOSITORY=${{ github.repository }}" \
              "VVP_WITNESS_CONFIG=/srv/config/witnesses-azure.json" \
              "VVP_ISSUER_DATA_DIR=/data/vvp-issuer"

  # =========================================================================
  # BUILD WITNESS IMAGE
  # =========================================================================
  # Build the custom witness image once, then deploy to all witnesses
  # Only runs when witness code changes
  build-witness-image:
    needs: [changes, test-verifier, test-issuer]
    if: needs.changes.outputs.witness == 'true'
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.build.outputs.image }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: |
          az acr login -n "${{ secrets.ACR_NAME }}"

      - name: Build and push witness image
        id: build
        run: |
          IMAGE="${{ secrets.ACR_LOGIN_SERVER }}/vvp-witness:${{ github.sha }}"
          echo "Building witness image: $IMAGE"
          docker build -t "$IMAGE" -f services/witness/Dockerfile .
          docker push "$IMAGE"
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

  # =========================================================================
  # DEPLOY WITNESSES
  # =========================================================================
  # Deploy the custom witness image to each witness container app
  # Only runs when witness code changes
  deploy-witnesses:
    needs: [changes, build-witness-image]
    if: needs.changes.outputs.witness == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        witness:
          - name: vvp-witness1
            witness_name: wan
            http_port: 5642
            tcp_port: 5632
          - name: vvp-witness2
            witness_name: wil
            http_port: 5643
            tcp_port: 5633
          - name: vvp-witness3
            witness_name: wes
            http_port: 5644
            tcp_port: 5634

    env:
      WITNESS_IMAGE: ${{ needs.build-witness-image.outputs.image }}

    steps:
      - name: Validate image output
        run: |
          if [ -z "$WITNESS_IMAGE" ]; then
            echo "WARNING: Witness image output is empty, constructing from secrets"
            # Fallback: construct image URL directly
            WITNESS_IMAGE="${{ secrets.ACR_LOGIN_SERVER }}/vvp-witness:${{ github.sha }}"
            echo "WITNESS_IMAGE=$WITNESS_IMAGE" >> $GITHUB_ENV
          fi
          echo "Using witness image: $WITNESS_IMAGE"

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy witness
        run: |
          echo "Deploying ${{ matrix.witness.name }} with image: $WITNESS_IMAGE"

          # Update the container app with the new image and environment variables
          az containerapp update \
            --name ${{ matrix.witness.name }} \
            --resource-group ${{ secrets.AZURE_RG }} \
            --image "$WITNESS_IMAGE" \
            --set-env-vars \
              "WITNESS_NAME=${{ matrix.witness.witness_name }}" \
              "HTTP_PORT=${{ matrix.witness.http_port }}" \
              "TCP_PORT=${{ matrix.witness.tcp_port }}" \
              "GIT_SHA=${{ github.sha }}"

      - name: Wait for witness to be ready
        run: |
          echo "Waiting for witness ${{ matrix.witness.name }} to be ready..."
          for i in {1..30}; do
            STATUS=$(az containerapp show \
              --name ${{ matrix.witness.name }} \
              --resource-group ${{ secrets.AZURE_RG }} \
              --query "properties.runningStatus" -o tsv)
            if [ "$STATUS" = "Running" ]; then
              echo "Witness is running"
              break
            fi
            echo "Attempt $i/30: Status is $STATUS, waiting..."
            sleep 10
          done

  # =========================================================================
  # VERIFY WITNESSES
  # =========================================================================
  # Only runs when witness code changes
  verify-witnesses:
    needs: [changes, deploy-witnesses]
    if: needs.changes.outputs.witness == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        witness:
          - name: vvp-witness1
            aid: BBilc4-L3tFUnfM_wJr4S4OJanAv_VmF_dJNN6vkf2Ha
          - name: vvp-witness2
            aid: BLskRTInXnMxWaGqcpSyMgo0nYbalW99cGZESrz3zapM
          - name: vvp-witness3
            aid: BIKKuvBwpmDVA4Ds-EpL5bt9OqPzWPja2LigFYZN2YfX

    steps:
      - name: Verify witness OOBI endpoint
        run: |
          WITNESS_URL="https://${{ matrix.witness.name }}.rcnx.io"
          OOBI_URL="${WITNESS_URL}/oobi/${{ matrix.witness.aid }}/controller"
          echo "Checking OOBI endpoint: $OOBI_URL"

          # Retry a few times in case witness is still warming up
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$OOBI_URL" || echo "000")
            echo "Attempt $i: HTTP response code: $HTTP_CODE"
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "202" ]; then
              echo "Witness OOBI endpoint is healthy"
              exit 0
            fi
            sleep 10
          done

          echo "::warning::Witness OOBI endpoint returned $HTTP_CODE after 5 attempts"

  # =========================================================================
  # POST-DEPLOYMENT INTEGRATION TESTS
  # =========================================================================
  # Run full E2E integration tests after deployment to verify the system works
  post-deployment-tests:
    needs: [changes, deploy-verifier, deploy-issuer]
    if: (needs.changes.outputs.verifier == 'true' || needs.changes.outputs.issuer == 'true') && !failure()
    runs-on: ubuntu-latest

    env:
      VVP_ISSUER_URL: https://vvp-issuer.rcnx.io
      VVP_VERIFIER_URL: https://vvp-verifier.rcnx.io
      VVP_TEST_MODE: azure

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install libsodium
        run: |
          sudo apt-get update
          sudo apt-get install -y libsodium-dev

      - name: Install keripy
        run: pip install keri>=1.2.0

      - name: Install common package
        working-directory: common
        run: pip install -e .

      - name: Install test dependencies
        run: |
          pip install pytest pytest-asyncio aiohttp httpx pysodium azure-storage-blob

      - name: Wait for services to be ready
        run: |
          echo "Waiting for issuer and verifier to be ready..."
          for i in {1..30}; do
            ISSUER_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$VVP_ISSUER_URL/healthz" || echo "000")
            VERIFIER_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$VVP_VERIFIER_URL/healthz" || echo "000")
            echo "Attempt $i/30: Issuer=$ISSUER_STATUS, Verifier=$VERIFIER_STATUS"
            if [ "$ISSUER_STATUS" = "200" ] && [ "$VERIFIER_STATUS" = "200" ]; then
              echo "Both services are ready"
              break
            fi
            sleep 10
          done

      - name: Run integration tests
        id: integration_tests
        env:
          VVP_TEST_API_KEY: ${{ secrets.VVP_ADMIN_API_KEY }}
          VVP_AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
        run: |
          START_TIME=$(date +%s)
          set +e

          # Run a subset of integration tests (skip benchmarks for speed)
          python -m pytest tests/integration/ \
            -v \
            --tb=short \
            -m "integration and not benchmark" \
            --ignore=tests/integration/benchmarks/ \
            2>&1 | tee test_output.txt

          TEST_EXIT_CODE=$?
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          # Parse test results
          PASSED=$(grep -oP '\d+(?= passed)' test_output.txt | tail -1 || echo "0")
          FAILED=$(grep -oP '\d+(?= failed)' test_output.txt | tail -1 || echo "0")
          TOTAL=$((PASSED + FAILED))

          # Set outputs
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT

          # Capture errors for reporting
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            grep -A 5 "FAILED\|ERROR" test_output.txt > errors.txt || true
          fi

          exit $TEST_EXIT_CODE

      - name: Submit test results to admin endpoint
        if: always()
        env:
          VVP_TEST_API_KEY: ${{ secrets.VVP_ADMIN_API_KEY }}
        run: |
          # Determine pass/fail status
          if [ "${{ steps.integration_tests.outputs.exit_code }}" = "0" ]; then
            PASSED_STATUS=true
          else
            PASSED_STATUS=false
          fi

          # Collect errors if any
          ERRORS="[]"
          if [ -f errors.txt ]; then
            ERRORS=$(cat errors.txt | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi

          # Submit results
          curl -X POST "${VVP_ISSUER_URL}/admin/deployment-tests" \
            -H "X-API-Key: ${VVP_TEST_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "git_sha": "${{ github.sha }}",
            "passed": ${PASSED_STATUS},
            "total_tests": ${{ steps.integration_tests.outputs.total || 0 }},
            "passed_tests": ${{ steps.integration_tests.outputs.passed || 0 }},
            "failed_tests": ${{ steps.integration_tests.outputs.failed || 0 }},
            "duration_seconds": ${{ steps.integration_tests.outputs.duration || 0 }},
            "issuer_url": "${VVP_ISSUER_URL}",
            "verifier_url": "${VVP_VERIFIER_URL}",
            "errors": ${ERRORS}
          }
          EOF

          echo "Test results submitted to ${VVP_ISSUER_URL}/admin/deployment-tests"

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            test_output.txt
            errors.txt
          retention-days: 7

  # =========================================================================
  # DEPLOY SIP REDIRECT SERVICE (PBX VM)
  # =========================================================================
  # Deploys to vvp-pbx VM with atomic symlink switch and rollback capability
  # Only runs when sip-redirect code changes and tests pass
  deploy-sip-redirect:
    needs: [changes, test-sip-redirect]
    if: needs.changes.outputs.sip-redirect == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Package service
        run: |
          VERSION="${{ github.sha }}"
          tar -czf "sip-redirect-${VERSION}.tar.gz" -C services/sip-redirect app/ pyproject.toml
          echo "Created package: sip-redirect-${VERSION}.tar.gz"
          ls -la "sip-redirect-${VERSION}.tar.gz"

      - name: Upload to Azure Blob
        run: |
          VERSION="${{ github.sha }}"
          az storage blob upload \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --container-name deployments \
            --name "sip-redirect/sip-redirect-${VERSION}.tar.gz" \
            --file "sip-redirect-${VERSION}.tar.gz" \
            --auth-mode login \
            --overwrite

      - name: Generate short-lived SAS URL (5 min expiry)
        id: sas
        run: |
          VERSION="${{ github.sha }}"
          EXPIRY=$(date -u -d "+5 minutes" '+%Y-%m-%dT%H:%MZ')
          SAS_URL=$(az storage blob generate-sas \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --container-name deployments \
            --name "sip-redirect/sip-redirect-${VERSION}.tar.gz" \
            --permissions r \
            --expiry "$EXPIRY" \
            --auth-mode login \
            --as-user \
            --full-uri \
            --output tsv)
          echo "url=$SAS_URL" >> $GITHUB_OUTPUT

      - name: Deploy with atomic symlink switch
        run: |
          VERSION="${{ github.sha }}"
          SAS_URL="${{ steps.sas.outputs.url }}"
          az vm run-command invoke \
            --resource-group VVP --name vvp-pbx \
            --command-id RunShellScript \
            --scripts "
              set -e
              VERSION='${VERSION}'
              DEPLOY_DIR=/opt/vvp/sip-redirect

              # Download using SAS URL (no az CLI needed on VM)
              curl -sSL -o /tmp/sip-redirect-\${VERSION}.tar.gz '${SAS_URL}'

              # Extract to versioned directory
              mkdir -p \${DEPLOY_DIR}/releases/\${VERSION}
              tar -xzf /tmp/sip-redirect-\${VERSION}.tar.gz -C \${DEPLOY_DIR}/releases/\${VERSION}

              # Atomic symlink switch
              ln -sfn \${DEPLOY_DIR}/releases/\${VERSION} \${DEPLOY_DIR}/current.new
              mv -Tf \${DEPLOY_DIR}/current.new \${DEPLOY_DIR}/current

              # Cleanup old releases (keep last 3)
              cd \${DEPLOY_DIR}/releases && ls -t | tail -n +4 | xargs -r rm -rf

              # Cleanup temp file
              rm -f /tmp/sip-redirect-\${VERSION}.tar.gz

              echo 'Deployed version: '\${VERSION}
            "

      - name: Validate systemd unit and restart
        run: |
          az vm run-command invoke \
            --resource-group VVP --name vvp-pbx \
            --command-id RunShellScript \
            --scripts "
              set -e
              # Verify unit file exists
              if [ ! -f /etc/systemd/system/vvp-sip-redirect.service ]; then
                echo 'ERROR: Systemd unit not found'
                exit 1
              fi

              # Reload and restart
              systemctl daemon-reload
              systemctl restart vvp-sip-redirect

              # Wait for startup
              sleep 5
              systemctl is-active vvp-sip-redirect
            "

      - name: Verify /status endpoint
        run: |
          sleep 10
          # Use /status endpoint with admin auth
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 30 \
            -H "X-Admin-Key: ${{ secrets.VVP_SIP_STATUS_ADMIN_KEY }}" \
            http://pbx.rcnx.io:8080/status || echo "000")
          if [ "$STATUS_CODE" != "200" ]; then
            echo "::warning::Status endpoint returned $STATUS_CODE (expected 200)"
          else
            echo "Status endpoint healthy (HTTP 200)"
          fi

      - name: Rollback on failure
        if: failure()
        run: |
          az vm run-command invoke \
            --resource-group VVP --name vvp-pbx \
            --command-id RunShellScript \
            --scripts "
              # List available releases
              echo 'Available releases:'
              ls -t /opt/vvp/sip-redirect/releases | head -5

              # Get previous release
              PREV=\$(ls -t /opt/vvp/sip-redirect/releases | sed -n '2p')
              if [ -n \"\$PREV\" ]; then
                ln -sfn /opt/vvp/sip-redirect/releases/\$PREV /opt/vvp/sip-redirect/current
                systemctl restart vvp-sip-redirect
                echo 'Rolled back to: '\$PREV
              else
                echo 'No previous release available for rollback'
              fi
            "

  # =========================================================================
  # DEPLOY SIP VERIFY SERVICE (PBX VM)
  # =========================================================================
  # Deploys to vvp-pbx VM with atomic symlink switch and rollback capability
  # Only runs when sip-verify code changes and tests pass
  deploy-sip-verify:
    needs: [changes, test-sip-verify]
    if: needs.changes.outputs.sip-verify == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Package service
        run: |
          VERSION="${{ github.sha }}"
          tar -czf "sip-verify-${VERSION}.tar.gz" -C services/sip-verify app/ pyproject.toml
          echo "Created package: sip-verify-${VERSION}.tar.gz"
          ls -la "sip-verify-${VERSION}.tar.gz"

      - name: Upload to Azure Blob
        run: |
          VERSION="${{ github.sha }}"
          az storage blob upload \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --container-name deployments \
            --name "sip-verify/sip-verify-${VERSION}.tar.gz" \
            --file "sip-verify-${VERSION}.tar.gz" \
            --auth-mode login \
            --overwrite

      - name: Generate short-lived SAS URL (5 min expiry)
        id: sas
        run: |
          VERSION="${{ github.sha }}"
          EXPIRY=$(date -u -d "+5 minutes" '+%Y-%m-%dT%H:%MZ')
          SAS_URL=$(az storage blob generate-sas \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --container-name deployments \
            --name "sip-verify/sip-verify-${VERSION}.tar.gz" \
            --permissions r \
            --expiry "$EXPIRY" \
            --auth-mode login \
            --as-user \
            --full-uri \
            --output tsv)
          echo "url=$SAS_URL" >> $GITHUB_OUTPUT

      - name: Deploy with atomic symlink switch
        run: |
          VERSION="${{ github.sha }}"
          SAS_URL="${{ steps.sas.outputs.url }}"
          az vm run-command invoke \
            --resource-group VVP --name vvp-pbx \
            --command-id RunShellScript \
            --scripts "
              set -e
              VERSION='${VERSION}'
              DEPLOY_DIR=/opt/vvp/sip-verify

              # Download using SAS URL (no az CLI needed on VM)
              curl -sSL -o /tmp/sip-verify-\${VERSION}.tar.gz '${SAS_URL}'

              # Extract to versioned directory
              mkdir -p \${DEPLOY_DIR}/releases/\${VERSION}
              tar -xzf /tmp/sip-verify-\${VERSION}.tar.gz -C \${DEPLOY_DIR}/releases/\${VERSION}

              # Atomic symlink switch
              ln -sfn \${DEPLOY_DIR}/releases/\${VERSION} \${DEPLOY_DIR}/current.new
              mv -Tf \${DEPLOY_DIR}/current.new \${DEPLOY_DIR}/current

              # Cleanup old releases (keep last 3)
              cd \${DEPLOY_DIR}/releases && ls -t | tail -n +4 | xargs -r rm -rf

              # Cleanup temp file
              rm -f /tmp/sip-verify-\${VERSION}.tar.gz

              echo 'Deployed version: '\${VERSION}
            "

      - name: Ensure systemd unit and restart
        run: |
          # Create systemd unit content (base64 encoded to avoid YAML issues)
          UNIT_B64=$(echo -e '[Unit]\nDescription=VVP SIP Verification Service\nAfter=network.target\n\n[Service]\nType=simple\nUser=root\nEnvironmentFile=/etc/vvp/sip-verify.env\nWorkingDirectory=/opt/vvp/sip-verify/current\nExecStart=/usr/bin/python3 -m app.main\nRestart=always\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\n' | base64 -w0)

          # Create env file content (base64 encoded)
          ENV_B64=$(echo -e 'VVP_VERIFIER_URL=https://vvp-verifier.rcnx.io\nVVP_SIP_VERIFY_PORT=5071\nVVP_REDIRECT_TARGET=127.0.0.1:5080\nPYTHONPATH=/opt/vvp/common-pkg/common\nLOG_LEVEL=INFO\n' | base64 -w0)

          az vm run-command invoke \
            --resource-group VVP --name vvp-pbx \
            --command-id RunShellScript \
            --scripts "
              set -e

              # Create systemd unit if not exists
              if [ ! -f /etc/systemd/system/vvp-sip-verify.service ]; then
                echo '${UNIT_B64}' | base64 -d > /etc/systemd/system/vvp-sip-verify.service
                systemctl daemon-reload
                systemctl enable vvp-sip-verify
                echo 'Created systemd unit'
              fi

              # Create env file if not exists
              if [ ! -f /etc/vvp/sip-verify.env ]; then
                mkdir -p /etc/vvp
                echo '${ENV_B64}' | base64 -d > /etc/vvp/sip-verify.env
                chmod 600 /etc/vvp/sip-verify.env
                echo 'Created env file'
              fi

              # Reload and restart
              systemctl daemon-reload
              systemctl restart vvp-sip-verify

              # Wait for startup
              sleep 5
              systemctl is-active vvp-sip-verify
            "

      - name: Verify service listening
        run: |
          sleep 5
          az vm run-command invoke \
            --resource-group VVP --name vvp-pbx \
            --command-id RunShellScript \
            --scripts "
              if ss -ulnp | grep -q ':5071'; then
                echo 'SIP Verify service listening on port 5071'
              else
                echo 'WARNING: Service not listening on port 5071'
                journalctl -u vvp-sip-verify -n 20 --no-pager
                exit 1
              fi
            "

      - name: Rollback on failure
        if: failure()
        run: |
          az vm run-command invoke \
            --resource-group VVP --name vvp-pbx \
            --command-id RunShellScript \
            --scripts "
              # List available releases
              echo 'Available releases:'
              ls -t /opt/vvp/sip-verify/releases 2>/dev/null | head -5 || echo 'No releases found'

              # Get previous release
              PREV=\$(ls -t /opt/vvp/sip-verify/releases 2>/dev/null | sed -n '2p')
              if [ -n \"\$PREV\" ]; then
                ln -sfn /opt/vvp/sip-verify/releases/\$PREV /opt/vvp/sip-verify/current
                systemctl restart vvp-sip-verify
                echo 'Rolled back to: '\$PREV
              else
                echo 'No previous release available for rollback'
              fi
            "

  # =========================================================================
  # DEPLOY PBX CONFIGURATION
  # =========================================================================
  # Deploys dialplan configuration to PBX VM
  # Only runs when pbx-config changes
  deploy-pbx-config:
    needs: [changes]
    if: needs.changes.outputs.pbx-config == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy dialplan (single command)
        run: |
          # Combine backup, deploy, and reload into a single VM command
          # This reduces conflicts with other az vm run-command operations
          if [ -f "services/pbx/config/public-sip.xml" ]; then
            CONTENT=$(base64 -w0 "services/pbx/config/public-sip.xml")
            echo "Deploying dialplan..."
            az vm run-command invoke \
              --resource-group VVP --name vvp-pbx \
              --command-id RunShellScript \
              --scripts "
                set -e
                BACKUP_DIR=/etc/freeswitch/dialplan/backup
                mkdir -p \$BACKUP_DIR
                cp /etc/freeswitch/dialplan/public.xml \$BACKUP_DIR/public.xml.\$(date +%Y%m%d%H%M%S) 2>/dev/null || true
                echo '$CONTENT' | base64 -d > /etc/freeswitch/dialplan/public.xml
                chown www-data:www-data /etc/freeswitch/dialplan/public.xml
                fs_cli -x 'reloadxml'
                echo 'Dialplan deployed and reloaded successfully'
              "
          fi
